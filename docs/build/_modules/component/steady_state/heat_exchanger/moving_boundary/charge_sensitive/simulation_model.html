<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../../../genindex.html" /><link rel="search" title="Search" href="../../../../../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.simulation_model - PyLaboThap Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=173837f2" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../../../index.html"><div class="brand">PyLaboThap Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../../../index.html">
  
  
  <span class="sidebar-brand-text">PyLaboThap Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../../../user_guide/installation_and_setup.html">Installation and Setup</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation and Setup</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../../../documentation/documentation_doc.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../../../documentation/connector/connector_doc.html">Connector</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Connector</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../documentation/connector/mass_connector/mass_connector_doc.html">Mass Connector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../documentation/connector/heat_connector/heat_connector_doc.html">Heat Connector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../documentation/connector/work_connector/work_connector_doc.html">Work Connector</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../../../documentation/component/component_doc.html">Components</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Components</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../../../documentation/component/steady_state/steady_state_doc.html">Steady-state models</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Steady-state models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../documentation/component/steady_state/base_component/base_component_doc.html">BaseComponent Class</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/models_doc.html">Steady-State Models</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Steady-State Models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5 has-children"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/volumetric_machine/volumetric_machine_doc.html">Volumetric Machine</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Volumetric Machine</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6 has-children"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/volumetric_machine/compressor/compressor_doc.html">Compressor</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Compressor</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/volumetric_machine/compressor/constant_isentropic_efficiency/constant_isentropic_efficiency_doc.html">Constant Isentropic Efficiency Compressor model</a></li>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/volumetric_machine/compressor/semi_empirical/semi_empirical_doc.html">Semi-empirical model of a volumetric compressor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5 has-children"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/heat_exchanger/heat_exchanger_doc.html">Heat Exchanger</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Heat Exchanger</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6 has-children"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/heat_exchanger/moving_boundary/moving_boundary_doc.html">Moving Boundary Heat Exchanger Models</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Moving Boundary Heat Exchanger Models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l7"><a class="reference internal" href="../../../../../../documentation/component/steady_state/models/heat_exchanger/moving_boundary/charge_sensitive/charge_sensitive_mb_doc.html">General Charge Sensitive Moving Boundary Model for Heat Exchangers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../notebooks/semi_empirical_cp_example.html">Semi-Empirical Compressor Model Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../../documentation/component/steady_state/base_component/exampleofsetup_doc.html">Example of a Steady-State Component Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../documentation/component/dynamic/dynamic_doc.html">Dynamic models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../../documentation/component/sizing/sizing_doc.html">Sizing models</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.simulation_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Supplemental code for paper:</span>
<span class="sd">I. Bell et al., &quot;A Generalized Moving-Boundary Algorithm to Predict the Heat Transfer Rate of </span>
<span class="sd">Counterflow Heat Exchangers for any Phase Configuration&quot;, Applied Thermal Engineering, 2014</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Modification w/r to previous version:</span>
<span class="sd">    - Putting some order in the Objective Function &quot;for&quot; loops. Sparing some</span>
<span class="sd">    lines of code.</span>
<span class="sd">    - x_di_c correct calculation.</span>
<span class="sd">    - Implementation of various correlations for htc and DP</span>
<span class="sd">    - Implementation of total DP linearly interpolated on all discretizations</span>
<span class="sd">    - Implemenation of the code in the LaboThap Python Library</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># External Toolbox </span>
<span class="kn">import</span> <span class="nn">CoolProp.CoolProp</span> <span class="k">as</span> <span class="nn">CP</span>
<span class="kn">from</span> <span class="nn">CoolProp.Plots</span> <span class="kn">import</span> <span class="n">PropertyPlot</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>


<span class="c1"># Internal Toolbox </span>
<span class="kn">import</span> <span class="nn">__init__</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.f_lmtd2</span> <span class="kn">import</span> <span class="n">f_lmtd2</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.propsfluid</span> <span class="kn">import</span> <span class="n">propsfluid</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.find_2P_boundaries</span> <span class="kn">import</span> <span class="n">find_2P_boundaries</span>

<span class="c1"># HTC and DP Correlations</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.plate_htc</span> <span class="kn">import</span> <span class="n">han_BPHEX_DP</span><span class="p">,</span> <span class="n">water_plate_HTC</span><span class="p">,</span> <span class="n">martin_BPHEX_HTC</span><span class="p">,</span> <span class="n">muley_manglik_BPHEX_HTC</span><span class="p">,</span> <span class="n">han_boiling_BPHEX_HTC</span><span class="p">,</span> <span class="n">han_cond_BPHEX_HTC</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.pipe_htc</span> <span class="kn">import</span> <span class="n">gnielinski_pipe_htc</span><span class="p">,</span> <span class="n">boiling_curve</span><span class="p">,</span> <span class="n">horizontal_tube_internal_condensation</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.shell_and_tube_htc</span> <span class="kn">import</span> <span class="n">shell_bell_delaware_htc</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.tube_bank_htc</span> <span class="kn">import</span> <span class="n">ext_tube_film_condens</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.fins</span> <span class="kn">import</span> <span class="n">htc_tube_and_fins</span>

<span class="c1"># Phase related correlations</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.void_fraction</span> <span class="kn">import</span> <span class="n">void_fraction</span>
<span class="kn">from</span> <span class="nn">component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.modules.kim_dry_out_incipience</span> <span class="kn">import</span> <span class="n">kim_dry_out_incipience</span>

<span class="c1"># Connectors</span>
<span class="kn">from</span> <span class="nn">connector.mass_connector</span> <span class="kn">import</span> <span class="n">MassConnector</span>
<span class="kn">from</span> <span class="nn">connector.heat_connector</span> <span class="kn">import</span> <span class="n">HeatConnector</span>

<span class="c1"># Component base frame</span>
<span class="kn">from</span> <span class="nn">component.base_component</span> <span class="kn">import</span> <span class="n">BaseComponent</span>

<span class="c1">#%%</span>
<span class="c1"># Set to True to enable some debugging output to screen</span>
<span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">#%%</span>

<div class="viewcode-block" id="HeatExchangerMB">
<a class="viewcode-back" href="../../../../../../documentation/component/steady_state/models/heat_exchanger/moving_boundary/charge_sensitive/charge_sensitive_mb_doc.html#component.steady_state.heat_exchanger.moving_boundary.charge_sensitive.simulation_model.HeatExchangerMB">[docs]</a>
<span class="k">class</span> <span class="nc">HeatExchangerMB</span><span class="p">(</span><span class="n">BaseComponent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Component: Heat Exchanger</span>

<span class="sd">        Model: The model is based on the the work of Ian Bell &quot;A generalized moving-boundary algorithm to predict the heat transfer</span>
<span class="sd">                rate of counterflow heat exchangers for any phase configuration&quot;. </span>

<span class="sd">        **Descritpion**:</span>

<span class="sd">                It is a moving-boundary model allowing for the precise estimation of its performance, pressure drops and fluid charges inside it (using a void fraction correlation for two-phase flow conditions). </span>
<span class="sd">                For now, the method has been adapted for many geometries : </span>
<span class="sd">                - Brazed-Plate heat exchangers</span>
<span class="sd">                - Shell-and-Tube heat exchangers</span>
<span class="sd">                - Cross-CounterFlow tube and fin heat exchangers</span>

<span class="sd">                The precision of the model and the geometry dependent charge estimation requires to know the geometry. </span>
<span class="sd">                The required parameters are adapted to the used heat transfer and pressure drop correlations that can be chosen from the ones implemented.</span>

<span class="sd">        **Assumptions**:</span>

<span class="sd">            - Steady-state operation.</span>
<span class="sd">            - Pressure drop proportional to the heat transfer area for each discretization.</span>
<span class="sd">            - Volume used for the charge computation are also assumed proportional to the heat transfer area for each discretization.</span>
<span class="sd">            - No loss to the ambient is considered.</span>

<span class="sd">        **Connectors**:</span>

<span class="sd">            su_H (MassConnector): Mass connector for the hot suction side.</span>
<span class="sd">            su_C (MassConnector): Mass connector for the cold suction side.</span>

<span class="sd">            ex_H (MassConnector): Mass connector for the hot exhaust side.</span>
<span class="sd">            ex_C (MassConnector): Mass connector for the cold exhaust side.</span>

<span class="sd">            Q_dot (HeatConnector): Heat connector for the heat transfer between the fluids</span>

<span class="sd">        **Parameters**:</span>

<span class="sd">            Parameters can be differentiated between geometrical parameters and simulation parameters. </span>

<span class="sd">            Simulation required parameters are: </span>

<span class="sd">            Flow_Type : Flow configuration of the fluid (&#39;CounterFlow&#39;, &#39;CrossFlow&#39;, &#39;Shell&amp;Tube&#39;, &#39;ParallelFlow&#39;) [-]</span>

<span class="sd">            htc_type  : Heat Transfer coefficient type (&#39;User-Defined&#39; or &#39;Correlation&#39;) [-]. If the &#39;User-Defined&#39; option is chosen,</span>
<span class="sd">            values for the different heat transfer coefficients can be manually passed by the user for different state conditions: </span>
<span class="sd">            &#39;Liquid&#39;, &#39;Vapor&#39;, &#39;Two-Phase&#39;, &#39;Vapor-wet&#39;, &#39;Dryout&#39;, &#39;Transcritical&#39;. If the &#39;Correlation&#39; option is chosen, then the names</span>
<span class="sd">            of implemented correlations shall be passed. For 1 phase heat transfer, 2 phases heat transfer and for pressure drops. </span>

<span class="sd">            H_DP_ON   : Hot side pressure drop considered or not [-]</span>
<span class="sd">            </span>
<span class="sd">            C_DP_ON   : Cold side pressure drop considered or not [-]</span>
<span class="sd">            </span>
<span class="sd">            n_disc    : number of heat exchanger discretizations [-]</span>
<span class="sd">        </span>
<span class="sd">            Geometry required parameters depend on the type of heat exchanger and on especially the used correlations. </span>
<span class="sd">            More information can be found in the documentation of the correlations themselves. </span>

<span class="sd">        **Inputs**:</span>

<span class="sd">            su_H_p: Hot suction side pressure. [Pa]</span>

<span class="sd">            su_H_h: Hot suction side enthalpy. [J/kg]</span>

<span class="sd">            su_H_fluid: Hot suction side fluid. [-]</span>

<span class="sd">            su_H_m_dot: Hot suction side mass flowrate. [kg/s]</span>

<span class="sd">            su_C_p: Cold suction side pressure. [Pa]</span>

<span class="sd">            su_C_h: Cold suction side enthalpy. [J/kg]</span>

<span class="sd">            su_C_fluid: Cold suction side fluid. [-]</span>

<span class="sd">            su_C_m_dot: Cold suction side mass flowrate. [kg/s]</span>

<span class="sd">        **Ouputs**:</span>

<span class="sd">            ex_H_h: Hot exhaust side specific enthalpy. [J/kg]</span>

<span class="sd">            ex_H_p: Hot exhaust side pressure. [Pa]</span>

<span class="sd">            ex_C_h: Cold exhaust side specific enthalpy. [J/kg]</span>

<span class="sd">            ex_C_p: Cold exhaust side pressure. [Pa]</span>

<span class="sd">            Q_dot: Heat transfer rate [W]</span>

<span class="sd">            M_H : Hot fluid charge [kg]</span>

<span class="sd">            M_C : Cold fluid charge [kg]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">H</span><span class="p">():</span>
        <span class="k">pass</span>
    <span class="k">class</span> <span class="nc">C</span><span class="p">():</span>
        <span class="k">pass</span>  
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HTX_Type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        su : Supply - &#39;H&#39; : hot</span>
<span class="sd">                    - &#39;C&#39; : cold</span>

<span class="sd">        ex : Exhaust - &#39;H&#39; : hot</span>
<span class="sd">                     - &#39;C&#39; : cold</span>
<span class="sd">                    </span>
<span class="sd">        Q_dot : Heat connection to the ambient</span>
<span class="sd">        </span>
<span class="sd">        HTX_Type : Type of HTX - Plate </span>
<span class="sd">                               - Shell and Tube</span>
<span class="sd">                               - Tube and Fins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span> <span class="o">=</span> <span class="n">MassConnector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span> <span class="o">=</span> <span class="n">MassConnector</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span> <span class="o">=</span> <span class="n">MassConnector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span> <span class="o">=</span> <span class="n">MassConnector</span><span class="p">()</span> <span class="c1"># Mass_connector</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Q_dot</span> <span class="o">=</span> <span class="n">HeatConnector</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span> <span class="ow">or</span> <span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span> <span class="ow">or</span> <span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">=</span> <span class="n">HTX_Type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Heat exchanger types implemented for this model are : &#39;Plate&#39;, &#39;Shell&amp;Tube&#39;, &#39;Tube&amp;Fins&#39;.&quot;</span><span class="p">)</span>

    <span class="c1">#%%    </span>
    
    <span class="k">def</span> <span class="nf">get_required_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># Used in check_calculablle to see if all of the required inputs are set</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hot side required inputs : </span>
<span class="sd">            </span>
<span class="sd">            - Hsu_T or Hsu_h : Hot supply temperature or enthalpy</span>
<span class="sd">            - Hsu_p          : Hot supply pressure</span>
<span class="sd">            - Hsu_fluid      : Hot supply fluid</span>
<span class="sd">            - Hsu_m_dot      : Hot supply flow rate</span>
<span class="sd">            </span>
<span class="sd">        Cold side required inputs : </span>
<span class="sd">            </span>
<span class="sd">            - Csu_T or Hsu_h : Cold supply temperature or enthalpy</span>
<span class="sd">            - Csu_p          : Cold supply pressure</span>
<span class="sd">            - Csu_fluid      : Cold supply fluid</span>
<span class="sd">            - Csu_m_dot      : Cold supply flow rate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_inputs</span><span class="p">()</span>
        <span class="c1"># Return a list of required inputs</span>
        <span class="k">return</span><span class="p">[</span><span class="s1">&#39;Hsu_p&#39;</span><span class="p">,</span> <span class="s1">&#39;Hsu_T&#39;</span><span class="p">,</span> <span class="s1">&#39;Hsu_m_dot&#39;</span><span class="p">,</span> <span class="s1">&#39;Hsu_fluid&#39;</span><span class="p">,</span> <span class="s1">&#39;Csu_p&#39;</span><span class="p">,</span> <span class="s1">&#39;Csu_T&#39;</span><span class="p">,</span> <span class="s1">&#39;Csu_m_dot&#39;</span><span class="p">,</span> <span class="s1">&#39;Csu_fluid&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">sync_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronize the inputs dictionary with the connector states.&quot;&quot;&quot;</span>
        <span class="c1"># Hot Fluid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">h</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">fluid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_fluid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">fluid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">m_dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_m_dot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">m_dot</span>
            
        <span class="c1"># Cold Fluid                </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">h</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">fluid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_fluid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">fluid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">m_dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_m_dot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">m_dot</span>

    <span class="k">def</span> <span class="nf">set_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set inputs directly through a dictionary and update connector properties.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># This line merges the keyword arguments (&#39;kwargs&#39;) passed to the &#39;set_inputs()&#39; method into the eisting &#39;self.inputs&#39; dictionary.</span>

        <span class="c1"># Update the connectors based on the new inputs</span>
        <span class="c1"># Hot Fluid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">set_fluid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_fluid&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Hsu_T&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">set_T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_T&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;Hsu_h&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">set_h</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_h&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Hsu_p&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">set_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_p&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Hsu_m_dot&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">set_m_dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Hsu_m_dot&#39;</span><span class="p">])</span>

        <span class="c1"># Cold Fluid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">set_fluid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_fluid&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Csu_T&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">set_T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_T&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;Csu_h&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">set_h</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_h&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Csu_p&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">set_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_p&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Csu_m_dot&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">set_m_dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Csu_m_dot&#39;</span><span class="p">])</span>

        <span class="k">return</span><span class="p">[</span><span class="s1">&#39;fluid_wf&#39;</span><span class="p">,</span> <span class="s1">&#39;su_wf_h&#39;</span><span class="p">,</span> <span class="s1">&#39;su_wf_m_dot&#39;</span><span class="p">,</span> <span class="s1">&#39;fluid_sf&#39;</span><span class="p">,</span> <span class="s1">&#39;su_sf_T&#39;</span><span class="p">,</span> <span class="s1">&#39;su_sf_cp&#39;</span><span class="p">,</span> <span class="s1">&#39;su_sf_m_dot&#39;</span><span class="p">]</span>

<span class="c1">#%%</span>

    <span class="k">def</span> <span class="nf">get_required_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General Parameters : </span>
<span class="sd">            </span>
<span class="sd">            - Flow_Type : Flow configuration of the fluid (&#39;CounterFlow&#39;, &#39;CrossFlow&#39;, &#39;Shell&amp;Tube&#39;, &#39;ParallelFlow&#39;)</span>
<span class="sd">            - htc_type  : Heat Transfer coefficient type (&#39;User-Defined&#39; or &#39;Correlation&#39;)</span>
<span class="sd">            - H_DP_ON   : Hot side pressure drop considered or not</span>
<span class="sd">            - C_DP_ON   : Cold side pressure drop considered or not</span>
<span class="sd">            - n_disc    : number of discretizations</span>
<span class="sd">        </span>
<span class="sd">        Geometry Parameters depend on specific geometry python files.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">general_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Flow_Type&#39;</span><span class="p">,</span><span class="s1">&#39;htc_type&#39;</span><span class="p">,</span> <span class="s1">&#39;H_DP_ON&#39;</span><span class="p">,</span> <span class="s1">&#39;C_DP_ON&#39;</span><span class="p">,</span><span class="s1">&#39;n_disc&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>     
            <span class="n">geometry_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A_c&#39;</span><span class="p">,</span> <span class="s1">&#39;A_h&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;l_v&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;C_CS&#39;</span><span class="p">,</span> <span class="s1">&#39;C_Dh&#39;</span><span class="p">,</span> <span class="s1">&#39;C_V_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;C_canal_t&#39;</span><span class="p">,</span> <span class="s1">&#39;C_n_canals&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;H_CS&#39;</span><span class="p">,</span> <span class="s1">&#39;H_Dh&#39;</span><span class="p">,</span> <span class="s1">&#39;H_V_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;H_canal_t&#39;</span><span class="p">,</span> <span class="s1">&#39;H_n_canals&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;casing_t&#39;</span><span class="p">,</span> <span class="s1">&#39;chevron_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;fooling&#39;</span><span class="p">,</span> 
                                   <span class="s1">&#39;n_plates&#39;</span><span class="p">,</span> <span class="s1">&#39;plate_cond&#39;</span><span class="p">,</span> <span class="s1">&#39;plate_pitch_co&#39;</span><span class="p">,</span> <span class="s1">&#39;t_plates&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                
            <span class="n">geometry_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A_eff&#39;</span><span class="p">,</span> <span class="s1">&#39;Baffle_cut&#39;</span><span class="p">,</span> <span class="s1">&#39;D_OTL&#39;</span><span class="p">,</span> <span class="s1">&#39;N_strips&#39;</span><span class="p">,</span> <span class="s1">&#39;S_V_tot&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Shell_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;T_V_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;Tube_L&#39;</span><span class="p">,</span> <span class="s1">&#39;Tube_OD&#39;</span><span class="p">,</span> <span class="s1">&#39;Tube_pass&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Tube_t&#39;</span><span class="p">,</span> <span class="s1">&#39;Tubesheet_t&#39;</span><span class="p">,</span> <span class="s1">&#39;central_spacing&#39;</span><span class="p">,</span> <span class="s1">&#39;clear_BS&#39;</span><span class="p">,</span> <span class="s1">&#39;clear_TB&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;cross_passes&#39;</span><span class="p">,</span> <span class="s1">&#39;foul_s&#39;</span><span class="p">,</span> <span class="s1">&#39;foul_t&#39;</span><span class="p">,</span> <span class="s1">&#39;inlet_spacing&#39;</span><span class="p">,</span> <span class="s1">&#39;n_series&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;n_tubes&#39;</span><span class="p">,</span> <span class="s1">&#39;outlet_spacing&#39;</span><span class="p">,</span> <span class="s1">&#39;pitch_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;tube_cond&#39;</span><span class="p">,</span> <span class="s1">&#39;tube_layout&#39;</span><span class="p">,</span> <span class="s1">&#39;Shell_Side&#39;</span><span class="p">]</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
            
            <span class="n">geometry_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A_finned&#39;</span><span class="p">,</span> <span class="s1">&#39;A_flow&#39;</span><span class="p">,</span> <span class="s1">&#39;A_in_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;A_out_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;A_unfinned&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;B_V_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;Fin_OD&#39;</span><span class="p">,</span> <span class="s1">&#39;Fin_per_m&#39;</span><span class="p">,</span> <span class="s1">&#39;Fin_t&#39;</span><span class="p">,</span> <span class="s1">&#39;Fin_type&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Finned_tube_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;T_V_tot&#39;</span><span class="p">,</span> <span class="s1">&#39;Tube_L&#39;</span><span class="p">,</span> <span class="s1">&#39;Tube_OD&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Tube_cond&#39;</span><span class="p">,</span> <span class="s1">&#39;Tube_t&#39;</span><span class="p">,</span> <span class="s1">&#39;fouling&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;k_fin&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;n_passes&#39;</span><span class="p">,</span> <span class="s1">&#39;n_rows&#39;</span><span class="p">,</span> <span class="s1">&#39;n_tubes&#39;</span><span class="p">,</span> <span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;pitch_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;tube_arrang&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;Fin_Side&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">general_parameters</span> <span class="o">+</span> <span class="n">geometry_parameters</span>
    
    <span class="k">def</span> <span class="nf">print_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Heat Exchanger Setup ===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connectors:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - H_su: fluid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">fluid</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, m_dot=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">m_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - C_su: fluid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">fluid</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, m_dot=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">m_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Inputs:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_inputs</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s2">: Not set&quot;</span><span class="p">)</span>


        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameters:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">: Not set&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================&quot;</span><span class="p">)</span>
           
<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">set_htc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">htc_type</span> <span class="o">=</span> <span class="s2">&quot;Correlation&quot;</span><span class="p">,</span> <span class="n">Corr_H</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Corr_C</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">UD_H_HTC</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">UD_C_HTC</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General Parameters : </span>
<span class="sd">            </span>
<span class="sd">            - htc_type : Heat Transfer coefficient type (&#39;User-Defined&#39; or &#39;Correlation&#39;)</span>
<span class="sd">            - Corr_H   : Correlations for hot side</span>
<span class="sd">            - Corr_C   : Correlations for cold side</span>
<span class="sd">            - UD_H_HTC : User-Defined HTC for hot side</span>
<span class="sd">            - UD_C_HTC : User-Defined HTC for cold side</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;htc_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">htc_type</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">check_calculable</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">htc_type</span> <span class="o">==</span> <span class="s2">&quot;User-Defined&quot;</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">=</span> <span class="s2">&quot;User-Defined&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">=</span> <span class="s2">&quot;User-Defined&quot;</span>
            
            <span class="c1"># !!! User-Defined Heat Transfer Coefficients (hot):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_liq</span> <span class="o">=</span> <span class="n">UD_H_HTC</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_vap</span> <span class="o">=</span> <span class="n">UD_H_HTC</span><span class="p">[</span><span class="s1">&#39;Vapor&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_twophase</span> <span class="o">=</span> <span class="n">UD_H_HTC</span><span class="p">[</span><span class="s1">&#39;Two-Phase&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_vapwet</span> <span class="o">=</span> <span class="n">UD_H_HTC</span><span class="p">[</span><span class="s1">&#39;Vapor-wet&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_tpdryout</span> <span class="o">=</span> <span class="n">UD_H_HTC</span><span class="p">[</span><span class="s1">&#39;Dryout&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_transcrit</span> <span class="o">=</span> <span class="n">UD_H_HTC</span><span class="p">[</span><span class="s1">&#39;Transcritical&#39;</span><span class="p">]</span>
        
            <span class="c1"># !!! User-Defined Heat Transfer Coefficients (cold):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_liq</span> <span class="o">=</span> <span class="n">UD_C_HTC</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_vap</span> <span class="o">=</span> <span class="n">UD_C_HTC</span><span class="p">[</span><span class="s1">&#39;Vapor&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_twophase</span> <span class="o">=</span> <span class="n">UD_C_HTC</span><span class="p">[</span><span class="s1">&#39;Two-Phase&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_vapwet</span> <span class="o">=</span> <span class="n">UD_C_HTC</span><span class="p">[</span><span class="s1">&#39;Vapor-wet&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_tpdryout</span> <span class="o">=</span> <span class="n">UD_C_HTC</span><span class="p">[</span><span class="s1">&#39;Dryout&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_transcrit</span> <span class="o">=</span> <span class="n">UD_C_HTC</span><span class="p">[</span><span class="s1">&#39;Transcritical&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_DP_ON&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># !!! arbitrarily set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mf">14.14</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">1.892</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>        
                    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_DP_ON&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mf">14.14</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">1.892</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Type </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">=</span> <span class="s2">&quot;Correlation&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">=</span> <span class="s2">&quot;Correlation&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">=</span> <span class="n">Corr_H</span><span class="p">[</span><span class="s2">&quot;1P&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">=</span> <span class="n">Corr_H</span><span class="p">[</span><span class="s2">&quot;2P&quot;</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">=</span> <span class="n">Corr_C</span><span class="p">[</span><span class="s2">&quot;1P&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">=</span> <span class="n">Corr_C</span><span class="p">[</span><span class="s2">&quot;2P&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_DP_ON&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># !!! arbitrarily set</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mf">14.14</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">1.892</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>        
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_DP_ON&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mf">14.14</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">1.892</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s2">&quot;Boiling_curve&quot;</span><span class="p">:</span> <span class="c1"># Compute the fluid boiling curve beforehand</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">T_sat</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">h_boil</span><span class="p">,</span> <span class="n">DT_vect</span><span class="p">)</span> <span class="o">=</span> <span class="n">boiling_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="n">T_sat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">C_f_boiling</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">DT_vect</span><span class="p">,</span><span class="n">h_boil</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">C_f_boiling</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000</span><span class="p">],[</span><span class="mi">20000</span><span class="p">,</span><span class="mi">20000</span><span class="p">])</span>
            
<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">external_pinching</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Determine the maximum heat transfer rate based on the external pinching analysis&quot;</span>
        
        <span class="s2">&quot;1) Set of arbitrary bound values&quot;</span> <span class="c1"># !!! Find out why      </span>
        <span class="n">T_hmin</span> <span class="o">=</span> <span class="mi">218</span> <span class="c1"># above CO2 freezing point (194.7 K)</span>
            
        <span class="n">T_cmax</span> <span class="o">=</span> <span class="mf">273.15</span><span class="o">+</span><span class="mi">250</span>
        
        <span class="s2">&quot;2) Hot fluid side pinch&quot;</span>
        
        <span class="c1"># Computation of outlet lowest possible enthalpy of the hot fluid using either the entrance cold fluid inlet temperature, or the arbitrary minimal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_ci</span><span class="p">,</span> <span class="n">T_hmin</span><span class="p">),</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span> <span class="c1"># Equation 5 (Bell et al. 2015)</span>
        
        <span class="c1"># Q_max computation</span>
        <span class="n">Qmaxh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span><span class="p">)</span> <span class="c1"># Equation 4 (Bell et al. 2015)</span>
        
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inlet Hot Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outlet Hot Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mdot_h = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Qmaxh =&quot;</span><span class="p">,</span> <span class="n">Qmaxh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="s2">&quot;3) Cold fluid side pinch&quot;</span>
                
        <span class="c1"># Computation of highest possible outlet enthalpy of the hot fluid using either the entrance hot fluid inlet temperature, or the arbitrary maximal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_hi</span><span class="p">,</span> <span class="n">T_cmax</span><span class="p">),</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span> <span class="c1"># Equation  (Bell et al. 2015)</span>
        
        <span class="c1"># Q_max computation</span>
        <span class="n">Qmaxc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_co</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">)</span> <span class="c1"># Equation 6 (Bell et al. 2015)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inlet Cold Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outlet Cold Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mdot_c = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Qmaxh =&quot;</span><span class="p">,</span> <span class="n">Qmaxc</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="s2">&quot;4) Final pinch and cell boundaries computation&quot;</span>
        
        <span class="n">Qmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Qmaxh</span><span class="p">,</span> <span class="n">Qmaxc</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Qmax (external pinching) is&#39;</span><span class="p">,</span> <span class="n">Qmax</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cell_boundaries</span><span class="p">(</span><span class="n">Qmax</span><span class="p">)</span> <span class="c1"># call calculate_cell_boundaries procedure</span>

        <span class="k">return</span> <span class="n">Qmax</span>
    
<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">calculate_cell_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Calculate the cell boundaries for each fluid &quot;&quot;&quot;</span>
        
        <span class="s2">&quot;1) Re-calculate the outlet enthalpies of each stream&quot;</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span> <span class="o">+</span> <span class="n">Q</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span> <span class="o">-</span> <span class="n">Q</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span>

        <span class="s2">&quot;2) Calculate the dew and bubble pressures and enthalpies by accounting for pressure drops&quot;</span>
        
        <span class="s2">&quot;2.1) For the cold fluid&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span> <span class="c1"># if not in transcritical</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DP_c</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">):</span>
                <span class="c1"># If no pressure drop is calculated or if the pressure drop is neglectable, assign saturation conditions to the ideal case:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_cdew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_cbubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_co</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_cbubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_cbubble_ideal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_cdew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_cdew_ideal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble_ideal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_cdew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cdew_ideal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h_cbubble</span><span class="p">,</span> <span class="n">h_cdew</span><span class="p">,</span> <span class="n">p_cbubble</span><span class="p">,</span> <span class="n">p_cdew</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">=</span> <span class="n">find_2P_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_co</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_cdew</span> <span class="o">=</span> <span class="n">p_cdew</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_cbubble</span> <span class="o">=</span> <span class="n">p_cbubble</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_cdew</span> <span class="o">=</span> <span class="n">h_cdew</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span> <span class="o">=</span> <span class="n">h_cbubble</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_cdew</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cdew</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_cbubble</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cbubble</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                
        <span class="s2">&quot;2.2) For the hot fluid&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DP_h</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
                <span class="c1">#If no pressure drop is calculated or if the pressure drop is neglectable, assign saturation conditions to the ideal case:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_hdew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_hbubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ho</span>    
                <span class="bp">self</span><span class="o">.</span><span class="n">T_hbubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_hbubble_ideal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_hdew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_hdew_ideal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble_ideal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew_ideal</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
                <span class="n">h_hbubble</span><span class="p">,</span> <span class="n">h_hdew</span><span class="p">,</span> <span class="n">p_hdew</span><span class="p">,</span> <span class="n">p_hbubble</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">=</span> <span class="n">find_2P_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ho</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_hdew</span> <span class="o">=</span> <span class="n">p_hdew</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_hbubble</span> <span class="o">=</span> <span class="n">p_hbubble</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span> <span class="o">=</span> <span class="n">h_hdew</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span> <span class="o">=</span> <span class="n">h_hbubble</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_hdew</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hdew</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_hbubble</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hbubble</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>

        <span class="s2">&quot;3) Discretization of the heat exchanger, user defined&quot;</span>
        <span class="c1"># The minimum number of cells desired is n_disc</span>
        <span class="c1"># n_disc is increased by 1. Now it is the minimum number of cells boundaries.</span>
        <span class="n">n_disc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_disc&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># Force the minimum number of discretizations needed</span>
        <span class="n">n_disc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_disc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># The original Bell2015 code uses: &quot;if h_cdew is not None&quot;. I don&#39;t see when that could happen without an error before.</span>
        <span class="s2">&quot;3.1) Create a vector of enthalpies : initiates the cell boundaries. If phase change, dew and bubble point are added&quot;</span>
        
        <span class="c1"># Cold side</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span><span class="p">,</span> <span class="n">n_disc</span><span class="p">),</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h_cdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
            <span class="c1">#In transcritical, just dont append the unexisting dew and bubble enthalpies</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span><span class="p">,</span> <span class="n">n_disc</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">))</span>
        <span class="c1"># Ensure that the enthalpy boundaries are all enclosed by the inlet and outlet conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span> <span class="ow">and</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_co</span><span class="p">)]</span>
        
        <span class="c1"># Hot side</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span><span class="p">,</span> <span class="n">n_disc</span><span class="p">),</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
            <span class="c1">#In transcritical, just dont append the unexisting dew and bubble enthalpies</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span><span class="p">,</span> <span class="n">n_disc</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">))</span>
        <span class="c1"># Ensure that the enthalpy boundaries are all enclosed by the inlet and outlet conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ho</span> <span class="ow">and</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="p">)]</span>

        <span class="s2">&quot;4) Filling of the complementary cell boundaries&quot;</span>
        
        <span class="c1"># Complementary cell boundaries serve to keep heat balances in check</span>
        <span class="c1"># Start at the first element in the vector</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># If there is only one cell</span>
                <span class="k">break</span>

            <span class="c1"># Determine which stream is the limiting next cell boundary</span>
            <span class="n">Qcell_hk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">Qcell_ck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k+1 Hot Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k Hot Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mdot_h = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Qcell_hk =&quot;</span><span class="p">,</span> <span class="n">Qcell_hk</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k+1 Cold Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k Cold Enthalpy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mdot_c = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Qcell_hk =&quot;</span><span class="p">,</span> <span class="n">Qcell_ck</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">Qcell_hk</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">round</span><span class="p">(</span><span class="n">Qcell_ck</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="c1"># Hot stream needs a complementary cell boundary as the available heat is higher than the cold cell heat absorption</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Qcell_ck</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="nb">round</span><span class="p">(</span><span class="n">Qcell_hk</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">round</span><span class="p">(</span><span class="n">Qcell_ck</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="c1"># Cold stream needs a complementary cell boundary as the available heat absoprtion is higher than the hot cell heat </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Qcell_hk</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">),</span><span class="n">Qcell_hk</span><span class="p">,</span> <span class="n">Qcell_ck</span><span class="p">)</span>

            <span class="c1"># Increment index</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modified Length of hvec_c is &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">))</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modified Length of hvec_h is &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">))</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">))</span> <span class="c1"># Ensures that the two fluid streams have the same number of cell boundaries</span>

        <span class="c1"># Calculate the vectors of exchanged heat in each cell.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qvec_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qvec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Qvec_c</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Qvec_h</span><span class="p">))</span><span class="o">&lt;</span><span class="mf">1e-5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Qvec_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qvec_c</span><span class="p">)</span>
            
        <span class="s2">&quot;5) Computation of the thermal states at the cell boundaries&quot;</span>
        
        <span class="c1"># Build the normalized enthalpy vectors (normalized by the total exchanged enthalpy)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hnorm_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hnorm_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Pressure distribution accross the HX. Method by RDickes (not validated).</span>
        <span class="c1"># Discretization of the pressure as a linear interpolation on enthalpy between in and out conditions # !!! Is this good ? </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hnorm_c</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hnorm_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p_co</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hnorm_h</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hnorm_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p_ho</span>

        <span class="c1"># Calculate the temperature and entropy at each cell boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svec_h</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">svec_c</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>


        <span class="s2">&quot;6) Vapour quality calculation if in the two-phase zone. If not, force, the value to -2 or 2&quot;</span>
        <span class="c1"># Take Transcritical into account. in that Case, force x = 3</span>
        
        <span class="s2">&quot;6.1) Hot Fluid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h_h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">h_h</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>        
                <span class="k">elif</span> <span class="n">h_h</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">h_h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                
        <span class="s2">&quot;6.2) Cold Fluid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h_c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">h_c</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>        
                <span class="k">elif</span> <span class="n">h_c</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cdew</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">h_c</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_cdew</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="s2">&quot;7) Vector of saturation temperatures at quality = 0.5, considering the pressure drop at each cell&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_sat_pure_c</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_sat_pure_h</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            
        <span class="s2">&quot;8) Calculate pinch and heat exchanger border temperature deltas&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">DT_pinch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DT_ho_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DT_hi_co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">internal_pinching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the maximum heat transfer rate based on the internal pinching analysis</span>
<span class="sd">        NB : external pinching analysis has already been done</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Try to find the dew point enthalpy as one of the cell boundaries</span>
        <span class="c1"># that is not the inlet or outlet</span>
        <span class="c1"># Do this only if the fluid is sub-critical</span>

        <span class="s2">&quot;1) Check for the hot stream&quot;</span>
        
        <span class="k">if</span> <span class="n">stream</span> <span class="o">==</span> <span class="s1">&#39;hot&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span> <span class="c1"># If the hot side is not transcritical</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    
                    <span class="c1"># Check if enthalpy is equal to the dewpoint enthalpy of hot stream and hot stream is colder than cold stream (impossible)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        
                        <span class="c1"># Enthalpy of the cold stream at the pinch temperature</span>
                        <span class="n">h_c_pinch</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">T_hdew</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span> <span class="c1"># Equation 10 (Bell et al. 2015)</span>

                        <span class="c1"># Heat transfer in the cell</span>
                        <span class="n">Qright</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span><span class="p">)</span> <span class="c1"># Equation 9 (Bell et al. 2015)</span>
                        
                        <span class="c1"># New value for the limiting heat transfer rate</span>
                        <span class="n">Qmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">*</span><span class="p">(</span><span class="n">h_c_pinch</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">)</span> <span class="o">+</span> <span class="n">Qright</span> <span class="c1"># Equation 12</span>

                        <span class="c1"># Recalculate the cell boundaries</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cell_boundaries</span><span class="p">(</span><span class="n">Qmax</span><span class="p">)</span>
                
                        <span class="k">return</span> <span class="n">Qmax</span>
                    
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span><span class="p">:</span>
                <span class="c1">#If the hot side is transcritical, do nothing</span>
                <span class="k">pass</span>
            
            <span class="s2">&quot;2) Check for the cold stream&quot;</span>
            
        <span class="k">elif</span> <span class="n">stream</span> <span class="o">==</span> <span class="s1">&#39;cold&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                <span class="c1"># Check for the cold stream pinch point</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    
                    <span class="c1"># Check if enthalpy is equal to the bubblepoint enthalpy of cold stream and hot stream is colder than cold stream (impossible)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        
                        <span class="c1"># Enthalpy of the cold stream at the pinch temperatur</span>
                        <span class="n">h_h_pinch</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">T_cbubble</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span> <span class="c1"># Equation 14 (Bell et al. 2015)</span>

                        <span class="c1"># Heat transfer in the cell</span>
                        <span class="n">Qleft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">)</span> <span class="c1"># Equation 13 (Bell et al. 2015)</span>

                        <span class="c1"># New value for the limiting heat transfer rate</span>
                        <span class="n">Qmax</span> <span class="o">=</span> <span class="n">Qleft</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="o">-</span><span class="n">h_h_pinch</span><span class="p">)</span> <span class="c1"># Equation 16 (Bell et al. 2015)</span>

                        <span class="c1"># Recalculate the cell boundaries</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cell_boundaries</span><span class="p">(</span><span class="n">Qmax</span><span class="p">)</span>

                        <span class="k">return</span> <span class="n">Qmax</span>
                    
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                <span class="c1">#If the hot side is transcritical, do nothing</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
    
    <span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_external</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">and_solve</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            - mdot_h : Hot fluid flowrate [kg/s]</span>
<span class="sd">            - p_hi : Hot fluid pressure [Pa]</span>
<span class="sd">            - h_hi : Hot fluid specific enthalpy [J/kg]</span>
<span class="sd">            - mdot_c : Cold fluid flowrate [kg/s]</span>
<span class="sd">            - p_ci : Cold fluid pressure [Pa]</span>
<span class="sd">            - h_ci : Cold fluid specific enthalpy [J/kg]</span>
<span class="sd">            - only_external (optional) : calls only exxternal_pinching function to determine Q_dot max if set to True (if there is no phase change)</span>
<span class="sd">            - and_solve (optional) : if set to true, solves the heat exchanger</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            - Q : Exchanged heat rate [W]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">check_calculable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_parametrized</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculable</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Component not calculable, check input&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrized</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Component not parametrized, check parameters&quot;</span><span class="p">)</span>            
            
        <span class="s2">&quot;1) Main Input variables&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">su_C</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">H_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span>  
            
        <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;INCOMP&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                
        <span class="c1"># Hot fluid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">m_dot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">p</span>
        
        <span class="c1"># Cold fluid </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">m_dot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">p</span>
                
        <span class="c1"># Determine the inlet temperatures from the pressure/enthalpy pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_ci</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_ci</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_hi</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>

        <span class="s2">&quot;2) Determine if the streams come in at a higher pressure than the transcritical pressure&quot;</span>
        
        <span class="c1"># Initialization of the flags:    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span> <span class="o">-</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;PCRIT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mf">1e-06</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="s2">&quot;3) Calculate the ideal bubble and dew temperatures/enthalpies for each stream IF the fluid is not transcritical&quot;</span>
        
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_cbubble_ideal</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_cdew_ideal</span>    <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble_ideal</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_cbubble_ideal</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_cdew_ideal</span>    <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_cdew_ideal</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>  
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_hbubble_ideal</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_hdew_ideal</span>    <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble_ideal</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_hbubble_ideal</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew_ideal</span>    <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_hdew_ideal</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
            
        <span class="s2">&quot;4) Calculate pressure drops&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_DP_ON&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># if the pressure drop are not neglected</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span> <span class="o">==</span> <span class="s1">&#39;Water&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DP_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">f_dp</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_ho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">DP_h</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># rho_v = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,1,&#39;P&#39;,self.p_hi,self.H_su.fluid)</span>
                <span class="c1"># rho_l = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,0,&#39;P&#39;,self.p_hi,self.H_su.fluid)</span>
                <span class="c1"># mu_h = CP.PropsSI(&#39;V&#39;,&#39;H&#39;,self.h_hi,&#39;P&#39;,self.p_hi,self.H_su.fluid)</span>
                
                <span class="c1"># G_h = (self.mdot_h/self.geom.H_n_canals)/self.geom.H_CS</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DP_h</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># self.H.f_dp[&quot;K&quot;] * self.mdot_h**(self.H.f_dp[&quot;B&quot;]) # Empirical correlations : DP = K*m_dot**B # Han_BPHEX_DP(mu_h, G_h, self.geom.H_Dh, self.geom.chevron_angle, self.geom.plate_pitch_co, rho_v, rho_l, self.geom.l_v, self.geom.H_n_canals, self.mdot_h, self.geom.H_canal_t) # </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_ho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_hi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">DP_h</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span> <span class="o">==</span> <span class="s1">&#39;Water&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DP_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">f_dp</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">DP_c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># rho_v = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,1,&#39;P&#39;,self.p_ci,self.C_su.fluid)</span>
                <span class="c1"># rho_l = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,0,&#39;P&#39;,self.p_ci,self.C_su.fluid)</span>
                <span class="c1"># mu_c = CP.PropsSI(&#39;V&#39;,&#39;H&#39;,self.h_ci,&#39;P&#39;,self.p_ci,self.C_su.fluid)               </span>
                
                <span class="c1"># G_c = (self.mdot_c/self.geom.C_n_canals)/self.geom.C_CS</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DP_c</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># self.C.f_dp[&quot;K&quot;] * self.mdot_c**(self.C.f_dp[&quot;B&quot;]) # Han_BPHEX_DP(mu_c, G_c, self.geom.H_Dh, self.geom.chevron_angle, self.geom.plate_pitch_co, rho_v, rho_l, self.geom.l_v, self.geom.C_n_canals, self.mdot_c, self.geom.C_canal_t) # </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_ci</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">DP_c</span>
            
        <span class="s2">&quot;5) Calculate maximum and actual heat rates&quot;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_hi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_ci</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-2</span>  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span>  <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Check that the operating conditions allow for heat transfer</span>
            
            <span class="s2">&quot;5.1) Compute the external pinching &amp; update cell boundaries&quot;</span>
            <span class="n">Qmax_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_pinching</span><span class="p">()</span> <span class="c1"># Call to external-pinching procedure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Qmax_ext</span> <span class="o">=</span> <span class="n">Qmax_ext</span>
            <span class="n">Qmax</span> <span class="o">=</span> <span class="n">Qmax_ext</span>
            
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;External pinching calculation done. </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="s2">&quot;5.2) Compute the internal pinching &amp; update cell boundaries&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">only_external</span><span class="p">:</span> <span class="c1"># If phase change is expected : Check the internal pinching</span>
                <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span><span class="s1">&#39;cold&#39;</span><span class="p">]:</span>
                    <span class="n">Qmax_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pinching</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="c1"># Call to internal-pinching procedure</span>
                    <span class="k">if</span> <span class="n">Qmax_int</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Qmax_int</span> <span class="o">=</span> <span class="n">Qmax_int</span>
                        <span class="n">Qmax</span> <span class="o">=</span> <span class="n">Qmax_int</span>
            
            <span class="c1"># Maximum heat transfer rate determined by external or internal pinching</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Qmax</span> <span class="o">=</span> <span class="n">Qmax</span>
            
            <span class="s2">&quot;5.3) Solve the heat exchanger to find the actual heat rate&quot;</span>
            <span class="k">if</span> <span class="n">and_solve</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_external</span><span class="p">:</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_hx</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Qmax</span> <span class="c1"># HTX efficiency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="c1"># HTX residual # !!! (what is &quot;w&quot; ?)</span>
            
            <span class="s2">&quot;5.4) Effective density computation for each cell taking into account void fraction&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">))</span>
            
            <span class="c1"># Cross section void fraction : considered constant along each discretization in the void_fraction function</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eps_void_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">))</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">eps_void_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eps_void_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rho_g</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">rho_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eps_void_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">void_fraction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rho_g</span><span class="p">,</span> <span class="n">rho_l</span><span class="p">)</span>
                    
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eps_void_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rho_g</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">rho_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eps_void_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">void_fraction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rho_g</span><span class="p">,</span> <span class="n">rho_l</span><span class="p">)</span>
            
            <span class="s2">&quot;5.5) Computation of the fluid mass inside the HTX&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="c1"># !!! Attention to this assumption</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Shell_Side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="c1"># Shell Side is the hot side</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="c1"># !!! Attention to this assumption</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;T_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;T_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="c1"># !!! Attention to this assumption</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>                    

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fin_Side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="c1"># Shell Side is the hot side</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;B_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="c1"># !!! Attention to this assumption</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;T_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;T_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="c1"># !!! Attention to this assumption</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;B_V_tot&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> 
                
            <span class="c1"># Initiates the mass vectors # !!! (for each cell ?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mvec_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mvec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Mass computation # Volume*Mean of the densities at the cell boundaries</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Mvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dvec_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_h</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Mvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dvec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dvec_c</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>

            <span class="k">if</span> <span class="n">and_solve</span><span class="p">:</span>
                
                <span class="c1"># Hot side</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">set_fluid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">set_T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">set_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">set_m_dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">m_dot</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">H_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span>
                    
                <span class="c1"># Cold side</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">set_fluid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">set_T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Example temperature [K]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">set_p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Example Pressure [Pa]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">set_m_dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">m_dot</span><span class="p">)</span> 
        
                <span class="bp">self</span><span class="o">.</span><span class="n">C_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span>
                                            
                <span class="bp">self</span><span class="o">.</span><span class="n">defined</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">Q</span>
            
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Just a flag if the heat exchanger is not solved</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="mi">1</span>
            
<span class="c1">#%%    </span>
    <span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
        
        <span class="s2">&quot;1) Initialize cell boundaries and results vectors&quot;</span>
        
        <span class="c1"># Cell boundaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cell_boundaries</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>

        <span class="c1"># Initialize dry-out incipience identification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_di_c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_out_c</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ColdSide_Props_Calculated</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Initialise results arrays</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># The wet-bulb potential temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Avec_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="s2">&quot;2) Iteration over all cells&quot;</span>
        
        <span class="c1"># The length of the hvec vectors is the same. hvec_h is arbitrarily taken below</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># iterate over each cell</span>
            
            <span class="s2">&quot;2.1) Diverse temperature parameter definition&quot;</span>
            
            <span class="n">Thi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">Tci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">Tho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">Tco</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">DTA</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Thi</span> <span class="o">-</span> <span class="n">Tco</span><span class="p">,</span> <span class="mf">1e-02</span><span class="p">)</span>
            <span class="n">DTB</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Tho</span> <span class="o">-</span> <span class="n">Tci</span><span class="p">,</span> <span class="mf">1e-02</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">DTA</span> <span class="o">==</span> <span class="n">DTB</span><span class="p">:</span>
                <span class="n">LMTD</span> <span class="o">=</span> <span class="n">DTA</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">LMTD</span> <span class="o">=</span> <span class="p">(</span><span class="n">DTA</span><span class="o">-</span><span class="n">DTB</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">DTA</span><span class="o">/</span><span class="n">DTB</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">VE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">DTA</span><span class="p">,</span> <span class="n">DTB</span><span class="p">)</span>
                    <span class="k">raise</span>
            
            <span class="c1"># Wall Temperature:</span>
            <span class="n">T_wall</span> <span class="o">=</span> <span class="p">(</span><span class="n">Thi</span> <span class="o">+</span> <span class="n">Tho</span> <span class="o">+</span> <span class="n">Tci</span> <span class="o">+</span> <span class="n">Tco</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
            
            <span class="c1"># Cold side</span>
            <span class="n">Tc_mean</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Tci</span> <span class="o">+</span> <span class="n">Tco</span><span class="p">)</span> <span class="c1"># mean temperature over the cell</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                <span class="n">Tc_sat_mean</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_sat_pure_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_sat_pure_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># mean saturation temperature over the cell</span>
                
            <span class="n">p_c_mean</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># mean pressure over the cell</span>
            
            <span class="c1"># Hot side</span>
            <span class="n">Th_mean</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Thi</span> <span class="o">+</span> <span class="n">Tho</span><span class="p">)</span> <span class="c1"># mean temperature over the cell</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
                <span class="n">Th_sat_mean</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_sat_pure_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_sat_pure_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># mean saturation temperature over the cell</span>
            
            <span class="n">p_h_mean</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># mean pressure over the cell</span>

            <span class="s2">&quot;2.2) Hot side phase identification&quot;</span>
            
            <span class="c1"># If not transcritical</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
                
                <span class="n">havg_h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span> <span class="c1"># Average cell enthalpy over the cell</span>
                
                <span class="k">if</span> <span class="n">havg_h</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hbubble</span><span class="p">:</span> <span class="c1"># below evaporation/bubble point</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;liquid&#39;</span><span class="p">)</span>
                    <span class="n">T_wall_h</span> <span class="o">=</span> <span class="n">T_wall</span>
                    
                <span class="k">elif</span> <span class="n">havg_h</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_hdew</span><span class="p">:</span> <span class="c1"># higher than condensation/dew point</span>
                    <span class="c1">#T_wall_h not used so far but it could appear in future Correlations implemented.</span>
                    <span class="n">T_wall_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">T_wall</span><span class="p">,</span> <span class="n">Th_sat_mean</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">T_wall</span> <span class="o">&gt;</span> <span class="n">Th_sat_mean</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vapor&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vapor-wet&#39;</span><span class="p">)</span>
                        
                <span class="k">else</span><span class="p">:</span> <span class="c1"># Between evaporation/bubble and condensation/dew point</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;two-phase&#39;</span><span class="p">)</span>
                    <span class="n">T_wall_h</span> <span class="o">=</span> <span class="n">T_wall</span>
                    
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_incomp_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;liquid&#39;</span><span class="p">)</span>
                <span class="n">T_wall_h</span> <span class="o">=</span> <span class="n">T_wall</span>
                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_h</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;transcritical&quot;</span><span class="p">)</span>
                <span class="n">T_wall_h</span> <span class="o">=</span> <span class="n">T_wall</span>
            
            <span class="s2">&quot;2.3) Cold side phase identification&quot;</span>

            <span class="c1"># If not transcritical</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                
                <span class="n">havg_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span> <span class="c1"># Average cell enthalpy over the cell</span>
                
                <span class="k">if</span> <span class="n">havg_c</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cbubble</span><span class="p">:</span> <span class="c1"># below evaporation/bubble point</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;liquid&#39;</span><span class="p">)</span>
                    <span class="c1">#The line comented below is the original line on the code. It is causing trouble.</span>
                    <span class="c1">#T_wall_c = min(T_wall, Tc_sat_mean)</span>
                    <span class="n">T_wall_c</span> <span class="o">=</span> <span class="n">T_wall</span>
                    
                <span class="k">elif</span> <span class="n">havg_c</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_cdew</span><span class="p">:</span> <span class="c1"># higher than condensation/dew point</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;vapor&quot;</span><span class="p">)</span>
                    <span class="n">T_wall_c</span> <span class="o">=</span> <span class="n">T_wall</span>
                    
                <span class="k">else</span><span class="p">:</span> <span class="c1"># Between evaporation/bubble and condensation/dew point</span>
                    <span class="n">T_wall_c</span> <span class="o">=</span> <span class="n">T_wall</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_di_c</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;two-phase&#39;</span><span class="p">)</span>  
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;two-phase-dryout&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dry_out_c</span> <span class="o">=</span> <span class="kc">True</span>
                        
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;transcritical&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>                
                <span class="n">G_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_n_canals&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_CS&#39;</span><span class="p">]</span>
                <span class="n">G_h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_n_canals&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_CS&#39;</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                <span class="n">A_in_one_tube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            
                <span class="c1"># Mass flow in tubes if the fluid is in the tubes</span>
                <span class="n">G_h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">A_in_one_tube</span>
                <span class="n">G_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">A_in_one_tube</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                <span class="n">A_in_one_tube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            
                <span class="c1"># Mass flow in tubes if the fluid is in the tubes</span>
                <span class="n">G_h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">A_in_one_tube</span>
                <span class="n">G_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">A_in_one_tube</span>
                
            <span class="c1"># F correction factor for LMTD method:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Flow_Type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;CounterFlow&quot;</span><span class="p">:</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">C_c</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_c_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">C_c</span> <span class="o">=</span> <span class="mi">20000</span>
                    
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">C_h</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Th_mean</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">C_h</span> <span class="o">=</span> <span class="mi">20000</span>
                
                <span class="n">C_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">C_c</span><span class="p">,</span><span class="n">C_h</span><span class="p">)</span>
                <span class="n">C_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">C_c</span><span class="p">,</span><span class="n">C_h</span><span class="p">)</span>
                
                <span class="n">C_r</span> <span class="o">=</span> <span class="n">C_min</span><span class="o">/</span><span class="n">C_max</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">Thi</span> <span class="o">-</span> <span class="n">Tho</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Tco</span> <span class="o">-</span> <span class="n">Tci</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tco</span> <span class="o">-</span> <span class="n">Tci</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Thi</span> <span class="o">-</span> <span class="n">Tci</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">f_lmtd2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">C_r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="c1">#UA_req including F correction factor in case of cross flow</span>
            <span class="n">UA_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">*</span><span class="n">LMTD</span><span class="p">)</span>          
            
            <span class="s2">&quot;3) Cell heat transfer coefficients&quot;</span>
            
            <span class="s2">&quot;3.1) Hot side - User defined&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">==</span> <span class="s2">&quot;User-Defined&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;liquid&quot;</span><span class="p">:</span>
                    <span class="n">alpha_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_liq</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor&quot;</span><span class="p">:</span>
                    <span class="n">alpha_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_vap</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span><span class="p">:</span>
                    <span class="n">alpha_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_twophase</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                    <span class="n">alpha_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_vapwet</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase-dryout&quot;</span><span class="p">:</span>
                    <span class="n">alpha_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_tpdryout</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transcritical&quot;</span><span class="p">:</span>
                    <span class="n">alpha_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">h_transcrit</span>
                    
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">==</span> <span class="s2">&quot;Correlation&quot;</span><span class="p">:</span> 
                
                <span class="c1"># Heat transfer coefficient calculated from Correlations.</span>
                <span class="c1"># Evaluate phases</span>
                
                <span class="c1"># 1 phase case</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;liquid&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transcritical&quot;</span><span class="p">:</span>
                                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s2">&quot;Gnielinski&quot;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Th_mean</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="n">T_wall_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">mu_h_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Th_mean</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;liquid&quot;</span><span class="p">:</span>
                                <span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Th_mean</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="n">T_wall_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">mu_h_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Th_mean</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor&quot;</span><span class="p">:</span>
                                <span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Th_mean</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="n">T_wall_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">mu_h_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Th_mean</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>
                            <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">G_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_Dh&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">])</span> <span class="c1"># Muley_Manglik_BPHEX_HTC(mu_h, mu_h_w, Pr_h, k_h, G_h, self.geom.H_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_h, Pr_h, k_h, G_h, self.geom.H_Dh) # </span>
                        
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                            <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">G_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">])</span> <span class="c1"># Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                        
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                            <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">G_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_passes&#39;</span><span class="p">])</span> <span class="c1"># Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                    
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s2">&quot;Shell_Bell_Delaware_HTC&quot;</span><span class="p">:</span>
                        <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">shell_bell_delaware_htc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">,</span> <span class="n">Th_mean</span><span class="p">,</span> <span class="n">T_wall</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                        
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s1">&#39;Tube_And_Fins&#39;</span><span class="p">:</span>
                        <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">htc_tube_and_fins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="n">Th_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fin_type&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        
                <span class="c1"># 2 phases case</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span><span class="p">:</span>
                        <span class="n">x_h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                        <span class="n">x_h</span> <span class="o">=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Thermodynamical variables</span>
                    <span class="n">mu_h_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">k_h_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">Pr_h_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;Prandtl&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">rho_h_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">rho_h_v</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="c1"># i_fg_h = CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 1, &#39;P&#39;, p_h_mean, self.H_su.fluid) - CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 0, &#39;P&#39;, p_h_mean, self.H_su.fluid)</span>
                    
                    <span class="c1"># !!! Include different types of Correlation HERE</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s2">&quot;Han_cond_BPHEX&quot;</span><span class="p">:</span>
                        <span class="n">alpha_h_2phase</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">DP_H</span> <span class="o">=</span> <span class="n">han_cond_BPHEX_HTC</span><span class="p">(</span><span class="n">x_h</span><span class="p">,</span> <span class="n">mu_h_l</span><span class="p">,</span> <span class="n">k_h_l</span><span class="p">,</span> <span class="n">Pr_h_l</span><span class="p">,</span> <span class="n">rho_h_l</span><span class="p">,</span> <span class="n">rho_h_v</span><span class="p">,</span> <span class="n">G_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_Dh&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plate_pitch_co&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chevron_angle&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;l_v&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_n_canals&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">m_dot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_canal_t&#39;</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s1">&#39;ext_tube_film_condens&#39;</span><span class="p">:</span>

                        <span class="n">V_flow</span> <span class="o">=</span> <span class="n">G_h</span><span class="o">/</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="n">havg_h</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s2">&quot;Shell_Bell_Delaware_HTC&quot;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span> 
                                <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">shell_bell_delaware_htc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">,</span> <span class="n">Th_mean</span><span class="p">,</span> <span class="n">T_wall</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">shell_bell_delaware_htc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_h</span><span class="p">,</span> <span class="n">Th_mean</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">T_wall</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                            
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s1">&#39;Tube_And_Fins&#39;</span><span class="p">:</span>
                            <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">htc_tube_and_fins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fin_type&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="n">alpha_h_2phase</span> <span class="o">=</span> <span class="n">ext_tube_film_condens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="n">Th_mean</span><span class="p">,</span> <span class="n">T_wall</span><span class="p">,</span> <span class="n">V_flow</span><span class="p">)</span>
                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s1">&#39;Horizontal_Tube_Internal_Condensation&#39;</span><span class="p">:</span>
                        <span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">k_h</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">),</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">havg_h</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">mu_h_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">T_wall</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_h_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                                
                        <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_h</span><span class="p">,</span> <span class="n">Pr_h</span><span class="p">,</span> <span class="n">Pr_h_w</span><span class="p">,</span> <span class="n">k_h</span><span class="p">,</span> <span class="n">G_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">])</span>
                        <span class="n">alpha_h_2phase</span> <span class="o">=</span> <span class="n">horizontal_tube_internal_condensation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span> <span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">p_h_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_h</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">T_wall</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">])</span>
                                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span><span class="p">:</span>
                        <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">alpha_h_2phase</span>
                        
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                        <span class="n">w_vap_wet</span> <span class="o">=</span> <span class="p">(</span><span class="n">Th_mean</span> <span class="o">-</span> <span class="n">Th_sat_mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Th_mean</span> <span class="o">-</span> <span class="n">T_wall</span><span class="p">)</span>
                        <span class="c1"># The line below re-calculates alpha_h in case of having a vapor-wet condition</span>
                        <span class="n">alpha_h</span> <span class="o">=</span> <span class="n">alpha_h_2phase</span> <span class="o">-</span> <span class="n">w_vap_wet</span><span class="o">*</span><span class="p">(</span><span class="n">alpha_h_2phase</span> <span class="o">-</span> <span class="n">alpha_h</span><span class="p">)</span> <span class="c1"># the last alpha_h in this equation is the 1 Phase calculation</span>

            <span class="s2">&quot;3.2) Cold side - User defined&quot;</span>
            
            <span class="c1"># User Defined</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">==</span> <span class="s2">&quot;User-Defined&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;liquid&quot;</span><span class="p">:</span>
                    <span class="n">alpha_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_liq</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor&quot;</span><span class="p">:</span>
                    <span class="n">alpha_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_vap</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span><span class="p">:</span>
                    <span class="n">alpha_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_twophase</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                    <span class="n">alpha_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_vapwet</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase-dryout&quot;</span><span class="p">:</span>
                    <span class="n">alpha_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_tpdryout</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transcritical&quot;</span><span class="p">:</span>
                    <span class="n">alpha_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h_transcrit</span>
                    
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">HeatExchange_Correlation</span> <span class="o">==</span> <span class="s2">&quot;Correlation&quot;</span><span class="p">:</span>

                <span class="c1"># Heat transfer coefficient calculated from Correlations:</span>
                <span class="c1"># Evaluate phases</span>
                
                <span class="c1"># 1 phase case</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;liquid&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transcritical&quot;</span><span class="p">:</span>
                    <span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Tc_mean</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="n">T_wall_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">:</span>
                        <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">water_plate_HTC</span><span class="p">(</span><span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">H_Dh</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_1phase</span>  <span class="o">==</span> <span class="s2">&quot;Gnielinski&quot;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Tc_mean</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="n">T_wall_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="n">Pr_c_w</span><span class="p">,</span> <span class="n">mu_c_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_c_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;liquid&quot;</span><span class="p">:</span>
                                <span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Tc_mean</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="n">T_wall_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">Pr_c_w</span><span class="p">,</span> <span class="n">mu_c_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_c_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor&quot;</span><span class="p">:</span>
                                <span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">mu_wall</span><span class="p">,</span> <span class="n">mu_rat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">propsfluid</span><span class="p">(</span><span class="n">Tc_mean</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="n">T_wall_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">Pr_c_w</span><span class="p">,</span> <span class="n">mu_c_w</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">((</span><span class="s1">&#39;PRANDTL&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">p_c_mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>
                            <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">Pr_c_w</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H_Dh&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">])</span> <span class="c1"># Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                        
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                            <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">Pr_c_w</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">])</span> <span class="c1"># Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                        
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                            <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">gnielinski_pipe_htc</span><span class="p">(</span><span class="n">mu_c</span><span class="p">,</span> <span class="n">Pr_c</span><span class="p">,</span> <span class="n">Pr_c_w</span><span class="p">,</span> <span class="n">k_c</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_passes&#39;</span><span class="p">])</span> <span class="c1"># Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                            
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s1">&#39;Shell_Bell_Delaware_HTC&#39;</span><span class="p">:</span>
                        <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">shell_bell_delaware_htc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="p">,</span> <span class="n">T_wall</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                         
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_1phase</span> <span class="o">==</span> <span class="s1">&#39;Tube_And_Fins&#39;</span><span class="p">:</span>
                        <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">htc_tube_and_fins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="n">Tc_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdot_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fin_type&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    
                    <span class="c1"># if self.C.Correlation_1phase  == &quot;Gnielinski&quot;:</span>
                    <span class="c1">#     alpha_c, _ = Gnielinski_Pipe_HTC(mu_c, Pr_c, k_c, G_c, self.geom.H_Dh, self.geom.l)</span>

                <span class="c1"># 2 phases case</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span><span class="p">:</span>
                        <span class="n">x_c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vec_c</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                        <span class="n">x_c</span> <span class="o">=</span> <span class="mi">1</span>
                        
                    <span class="c1"># Thermodynamical variables</span>
                    <span class="n">mu_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">k_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">Pr_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;Prandtl&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">rho_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">rho_c_v</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">i_fg_c</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span> <span class="o">-</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    
                    <span class="c1"># This boolean serves to spare to recalculate this properties in the dry-out analysis further ahead.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ColdSide_Props_Calculated</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="c1"># !!! Include different types of Correlation HERE</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s2">&quot;Han_cond_BPHEX&quot;</span><span class="p">:</span>
                        <span class="n">alpha_c_2phase</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">han_cond_BPHEX_HTC</span><span class="p">(</span><span class="n">x_c</span><span class="p">,</span> <span class="n">mu_c_l</span><span class="p">,</span> <span class="n">k_c_l</span><span class="p">,</span> <span class="n">Pr_c_l</span><span class="p">,</span> <span class="n">rho_c_l</span><span class="p">,</span> <span class="n">rho_c_v</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_Dh&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plate_pitch_co&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chevron_angle&#39;</span><span class="p">])</span>
                    
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s2">&quot;Han_Boiling_BPHEX_HTC&quot;</span><span class="p">:</span>
                        <span class="n">alpha_c_2phase</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">han_boiling_BPHEX_HTC</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_di_c</span><span class="p">),</span> <span class="n">mu_c_l</span><span class="p">,</span> <span class="n">k_c_l</span><span class="p">,</span> <span class="n">Pr_c_l</span><span class="p">,</span> <span class="n">rho_c_l</span><span class="p">,</span> <span class="n">rho_c_v</span><span class="p">,</span>  <span class="n">i_fg_c</span><span class="p">,</span> <span class="n">G_c</span><span class="p">,</span> <span class="n">LMTD</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">alpha_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_Dh&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chevron_angle&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plate_pitch_co&#39;</span><span class="p">])</span>
                    
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">Correlation_2phase</span> <span class="o">==</span> <span class="s2">&quot;Boiling_curve&quot;</span><span class="p">:</span>                  
                        <span class="n">alpha_c_2phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_f_boiling</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">T_wall</span> <span class="o">-</span> <span class="n">Tc_mean</span><span class="p">))</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Correlation not found for Cold Side 2-Phase&quot;</span><span class="p">)</span>
                            
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span><span class="p">:</span>
                        <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">alpha_c_2phase</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vapor-wet&quot;</span><span class="p">:</span>
                        <span class="n">w_vap_wet</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tc_mean</span> <span class="o">-</span> <span class="n">Tc_sat_mean</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Tc_mean</span> <span class="o">-</span> <span class="n">T_wall</span><span class="p">)</span>
                        <span class="c1">#The line below re-calculates alpha_h in case of having a vapor-wet condition</span>
                        <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">alpha_c_2phase</span> <span class="o">-</span> <span class="n">w_vap_wet</span><span class="o">*</span><span class="p">(</span><span class="n">alpha_c_2phase</span> <span class="o">-</span> <span class="n">alpha_c</span><span class="p">)</span> <span class="c1">#the last alpha_c in this equation is the 1 Phase calculation</span>
            
            <span class="s2">&quot;3.3) Store the heat transfer coefficients&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_h</span><span class="p">)</span>
            
            <span class="s2">&quot;4) Recover some parameters and conductivity calculation and compute UA_avail&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>     
                <span class="c1"># In the equation below, thickness resistance is given with respect to A_h arbitrarely</span>
                <span class="n">UA_avail</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fooling&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_h&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_c&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;t_plates&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plate_cond&#39;</span><span class="p">]))</span> 
                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>       
                
                <span class="n">fact_cond_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">]))</span>
                <span class="n">fact_cond_2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;tube_cond&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_series&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">]</span>
                <span class="n">R_cond</span> <span class="o">=</span> <span class="n">fact_cond_1</span><span class="o">/</span><span class="n">fact_cond_2</span>                      

                <span class="bp">self</span><span class="o">.</span><span class="n">A_in_tubes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_pass&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_out_tubes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_pass&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">])</span>
            
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;foul_s&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">R_fouling_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;foul_s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_out_tubes</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">R_fouling_s</span> <span class="o">=</span> <span class="mi">0</span>
    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;foul_t&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">R_fouling_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;foul_t&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_in_tubes</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">R_fouling_t</span> <span class="o">=</span> <span class="mi">0</span>                
            
                <span class="n">UA_avail</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_in_tubes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_out_tubes</span><span class="p">)</span> <span class="o">+</span> <span class="n">R_fouling_s</span> <span class="o">+</span> <span class="n">R_fouling_t</span> <span class="o">+</span> <span class="n">R_cond</span><span class="p">)</span> 
            
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                
                <span class="n">fact_cond_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">]))</span>
                <span class="n">fact_cond_2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_cond&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_passes&#39;</span><span class="p">]</span>
                <span class="n">R_cond</span> <span class="o">=</span> <span class="n">fact_cond_1</span><span class="o">/</span><span class="n">fact_cond_2</span>                      
                
                <span class="bp">self</span><span class="o">.</span><span class="n">A_in_tubes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_passes&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_L&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_tubes&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">]))</span> <span class="c1"># *self.geom.n_passes </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_out_tubes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_finned&#39;</span><span class="p">]</span>
                            
                <span class="c1">#☺ self.A_out_tubes = 8705 #self.geom.n_passes*self.geom.Tube_L*self.geom.n_tubes*np.pi*(self.geom.Tube_OD)</span>
            
                <span class="n">R_fouling</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># self.geom.fouling / self.A_out_tubes             </span>
                        
                <span class="c1"># In the equation below, thickness resistance is given with respect to A_h arbitrarely</span>
            
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fin_Side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="c1"># Fin side is the hot side </span>
                    <span class="n">UA_avail</span> <span class="o">=</span>  <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_in_tubes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_out_tubes</span><span class="p">)</span> <span class="o">+</span> <span class="n">R_fouling</span> <span class="o">+</span> <span class="n">R_cond</span><span class="p">)</span> <span class="c1"># 1/((1+self.geom.fooling)/(alpha_h*self.geom.A_h) + 1/(alpha_c*self.geom.A_c) + t/(self.geom.tube_cond)) </span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">UA_avail</span> <span class="o">=</span>  <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_in_tubes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_out_tubes</span><span class="p">)</span> <span class="o">+</span> <span class="n">R_fouling</span> <span class="o">+</span> <span class="n">R_cond</span><span class="p">)</span> <span class="c1"># 1/((1+self.geom.fooling)/(alpha_h*self.geom.A_h) + 1/(alpha_c*self.geom.A_c) + t/(self.geom.tube_cond)) </span>
      
            <span class="c1"># R_fooling_h = self.params.H.R_fooling </span>
            <span class="c1"># R_fooling_c = self.params.C.R_fooling</span>
            
            <span class="s2">&quot;5) Calculate w, the main objective of this function. This variable serves for residual minimization in the solver&quot;</span>
            
            <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UA_req</span><span class="o">/</span><span class="n">UA_avail</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Avec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_h&#39;</span><span class="p">])</span> 
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Avec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_eff&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Tube&amp;Fins&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Avec_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_finned&#39;</span><span class="p">])</span>
            
            <span class="s2">&quot;5.1) Calculate dryout incipience only if subcritical&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_out_c</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;two-phase&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Transcritical_c</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ColdSide_Props_Calculated</span><span class="p">:</span>
                        <span class="c1">#If these properties where not calculated before, do it:</span>
                        <span class="n">mu_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        <span class="n">rho_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        <span class="n">rho_c_v</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        <span class="n">i_fg_c</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span> <span class="o">-</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    
                    <span class="n">P_star_c</span> <span class="o">=</span> <span class="n">p_c_mean</span><span class="o">/</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;Pcrit&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                    <span class="n">q_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qvec_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Avec_h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sigma_c_l</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">p_c_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Plate&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">x_di_c</span> <span class="o">=</span> <span class="n">kim_dry_out_incipience</span><span class="p">(</span><span class="n">G_c</span><span class="p">,</span> <span class="n">q_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;C_Dh&#39;</span><span class="p">],</span> <span class="n">P_star_c</span><span class="p">,</span> <span class="n">rho_c_l</span><span class="p">,</span> <span class="n">rho_c_v</span><span class="p">,</span> <span class="n">mu_c_l</span><span class="p">,</span> <span class="n">sigma_c_l</span><span class="p">,</span> <span class="n">i_fg_c</span><span class="p">)</span>
                            
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HTX_Type</span> <span class="o">==</span> <span class="s1">&#39;Shell&amp;Tube&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">x_di_c</span> <span class="o">=</span> <span class="n">kim_dry_out_incipience</span><span class="p">(</span><span class="n">G_c</span><span class="p">,</span> <span class="n">q_c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_OD&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Tube_t&#39;</span><span class="p">],</span> <span class="n">P_star_c</span><span class="p">,</span> <span class="n">rho_c_l</span><span class="p">,</span> <span class="n">rho_c_v</span><span class="p">,</span> <span class="n">mu_c_l</span><span class="p">,</span> <span class="n">sigma_c_l</span><span class="p">,</span> <span class="n">i_fg_c</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">x_di_c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
            
        <span class="k">return</span> <span class="mi">1</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">solve_hx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Solve the objective function using Brent&#39;s method and the maximum heat transfer </span>
<span class="sd">        rate calculated from the pinching analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_function</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmax</span><span class="o">-</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="n">xtol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>
    
<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">plot_objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot the objective function &quot;&quot;&quot;</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Qmax</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_function</span><span class="p">(</span><span class="n">_Q</span><span class="p">)</span> <span class="k">for</span> <span class="n">_Q</span> <span class="ow">in</span> <span class="n">Q</span><span class="p">])</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># plt.show()²</span>
        
<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">plot_ph_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot p-h plots for the pair of working fluids &quot;&quot;&quot;</span>
        <span class="n">Ph_diagram_h</span> <span class="o">=</span> <span class="n">PropertyPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="s2">&quot;PH&quot;</span><span class="p">,</span> <span class="n">unit_system</span> <span class="o">=</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.001</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_h</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_h</span><span class="o">*</span><span class="mf">1e-05</span><span class="p">,</span><span class="s1">&#39;s-&#39;</span><span class="p">)</span>
        <span class="n">Ph_diagram_h</span><span class="o">.</span><span class="n">calc_isolines</span><span class="p">()</span>
        <span class="n">Ph_diagram_h</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hot side P-h diagram. Fluid: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">))</span>
        <span class="n">Ph_diagram_h</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1">#----------------------------------------------------------------------</span>
        <span class="n">Ph_diagram_c</span> <span class="o">=</span> <span class="n">PropertyPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="s2">&quot;PH&quot;</span><span class="p">,</span> <span class="n">unit_system</span> <span class="o">=</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.001</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvec_c</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec_c</span><span class="o">*</span><span class="mf">1e-05</span><span class="p">,</span><span class="s1">&#39;s-&#39;</span><span class="p">)</span>
        <span class="n">Ph_diagram_c</span><span class="o">.</span><span class="n">calc_isolines</span><span class="p">()</span>
        <span class="n">Ph_diagram_c</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cold side P-h diagram. Fluid: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">))</span>
        <span class="n">Ph_diagram_c</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>

<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">plot_Ts_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot a T-s plot for the pair of working fluids &quot;&quot;&quot;</span>
        <span class="n">Ph_diagram_h</span> <span class="o">=</span> <span class="n">PropertyPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="s2">&quot;TS&quot;</span><span class="p">,</span> <span class="n">unit_system</span> <span class="o">=</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.001</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">svec_h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span><span class="s1">&#39;s-&#39;</span><span class="p">)</span>
        <span class="n">Ph_diagram_h</span><span class="o">.</span><span class="n">calc_isolines</span><span class="p">()</span>
        <span class="n">Ph_diagram_h</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hot side T-s diagram. Fluid: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">))</span>
        <span class="n">Ph_diagram_h</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1"># #----------------------------------------------------------------------</span>
        <span class="n">Ph_diagram_c</span> <span class="o">=</span> <span class="n">PropertyPlot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">,</span> <span class="s2">&quot;TS&quot;</span><span class="p">,</span> <span class="n">unit_system</span> <span class="o">=</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.001</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">svec_c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span><span class="s1">&#39;s-&#39;</span><span class="p">)</span>
        <span class="n">Ph_diagram_c</span><span class="o">.</span><span class="n">calc_isolines</span><span class="p">()</span>
        <span class="n">Ph_diagram_c</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cold side T-s diagram. Fluid: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_su</span><span class="o">.</span><span class="n">fluid</span><span class="p">))</span>
        <span class="n">Ph_diagram_c</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>

<span class="c1">#%%</span>
    <span class="k">def</span> <span class="nf">plot_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">400</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot the cells of the heat exchanger &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hnorm_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_h</span><span class="p">,</span> <span class="s1">&#39;rs-&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hnorm_c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tvec_c</span><span class="p">,</span> <span class="s1">&#39;bs-&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T [K]&#39;</span><span class="p">)</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\hat h$ [-]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fName</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fName</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_states_connectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Heat Exchanger States ===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connectors:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - su_C: fluid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">fluid</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, m_dot=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_C</span><span class="o">.</span><span class="n">m_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - su_H: fluid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">fluid</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, m_dot=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">su_H</span><span class="o">.</span><span class="n">m_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ex_C: fluid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">fluid</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, m_dot=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_C</span><span class="o">.</span><span class="n">m_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ex_H: fluid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">fluid</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, m_dot=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_H</span><span class="o">.</span><span class="n">m_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Q_dot: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_dot</span><span class="o">.</span><span class="n">Q_dot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======================&quot;</span><span class="p">)</span></div>


<span class="c1"># &quot;&quot;&quot;</span>
<span class="c1"># Supplemental code for paper:</span>
<span class="c1"># I. Bell et al., &quot;A Generalized Moving-Boundary Algorithm to Predict the Heat Transfer Rate of </span>
<span class="c1"># Counterflow Heat Exchangers for any Phase Configuration&quot;, Applied Thermal Engineering, 2014</span>
<span class="c1"># &quot;&quot;&quot;</span>

<span class="c1"># &quot;&quot;&quot;</span>
<span class="c1"># Modification w/r to previous version:</span>
<span class="c1">#     - Putting some order in the Objective Function &quot;for&quot; loops. Sparing some</span>
<span class="c1">#     lines of code.</span>
<span class="c1">#     - x_di_c correct calculation.</span>
<span class="c1"># &quot;&quot;&quot;</span>

<span class="c1"># # from __future__ import division, print_function</span>

<span class="c1"># # import sys</span>
<span class="c1"># # sys.path.append(&#39;C:/Users/Elise/OneDrive - Universite de Liege/Documenten/Thesis/Python_Library&#39;)</span>

<span class="c1"># &quot;&quot;&quot;</span>
<span class="c1"># Supplemental code for paper:</span>
<span class="c1"># I. Bell et al., &quot;A Generalized Moving-Boundary Algorithm to Predict the Heat Transfer Rate of </span>
<span class="c1"># Counterflow Heat Exchangers for any Phase Configuration&quot;, Applied Thermal Engineering, 2014</span>
<span class="c1"># &quot;&quot;&quot;</span>

<span class="c1"># &quot;&quot;&quot;</span>
<span class="c1"># Modification w/r to previous version:</span>
<span class="c1">#     - Putting some order in the Objective Function &quot;for&quot; loops. Sparing some</span>
<span class="c1">#     lines of code.</span>
<span class="c1">#     - x_di_c correct calculation.</span>
<span class="c1">#     - Implementation of various correlations for htc and DP</span>
<span class="c1">#     - Implementation of total DP linearly interpolated on all discretizations</span>
<span class="c1">#     - Implemenation of the code in the LaboThap Python Library</span>
<span class="c1"># &quot;&quot;&quot;</span>

<span class="c1"># # External Toolbox </span>
<span class="c1"># import CoolProp.CoolProp as CP</span>
<span class="c1"># from CoolProp.Plots import PropertyPlot</span>
<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># import numpy as np</span>
<span class="c1"># import scipy.optimize</span>
<span class="c1"># from scipy.interpolate import interp1d</span>

<span class="c1"># import os, sys</span>
<span class="c1"># sys.path.append(os.path.abspath(&quot;..&quot;))</span>

<span class="c1"># # Internal Toolbox </span>
<span class="c1"># from modules.f_lmtd2 import f_lmtd2</span>
<span class="c1"># from modules.propsfluid import propsfluid</span>
<span class="c1"># from modules.find_2P_boundaries import find_2P_boundaries</span>

<span class="c1"># # HTC and DP Correlations</span>
<span class="c1"># from modules.plate_htc import han_BPHEX_DP, water_plate_HTC, martin_BPHEX_HTC, muley_manglik_BPHEX_HTC, han_boiling_BPHEX_HTC, han_cond_BPHEX_HTC</span>
<span class="c1"># from modules.pipe_htc import gnielinski_pipe_htc, boiling_curve, horizontal_tube_internal_condensation</span>
<span class="c1"># from modules.shell_and_tube_htc import shell_bell_delaware_htc</span>
<span class="c1"># from modules.tube_bank_htc import ext_tube_film_condens</span>
<span class="c1"># from modules.fins import htc_tube_and_fins</span>

<span class="c1"># # Phase related correlations</span>
<span class="c1"># from modules.void_fraction import void_fraction</span>
<span class="c1"># from modules.kim_dry_out_incipience import kim_dry_out_incipience</span>

<span class="c1"># # Connectors</span>
<span class="c1"># from connector.mass_connector import MassConnector</span>
<span class="c1"># from connector.heat_connector import HeatConnector</span>

<span class="c1"># # Component base frame</span>
<span class="c1"># from component.base_component import BaseComponent</span>

<span class="c1"># #%%</span>
<span class="c1"># # Set to True to enable some debugging output to screen</span>
<span class="c1"># debug = False</span>

<span class="c1"># #%%</span>

<span class="c1"># class MB_HeatExchanger(BaseComponent):</span>
       
<span class="c1">#     class H():</span>
<span class="c1">#         pass</span>
    
<span class="c1">#     class C():</span>
<span class="c1">#         pass</span>
    
<span class="c1">#     def __init__(self, HTX_Type):</span>
<span class="c1">#         super().__init__()</span>
        
<span class="c1">#         self.su = {&#39;H&#39; : MassConnector(),</span>
<span class="c1">#                    &#39;C&#39; : MassConnector()}</span>
        
<span class="c1">#         self.ex = {&#39;H&#39; : MassConnector(),</span>
<span class="c1">#                    &#39;C&#39; : MassConnector()} # Mass_connector</span>
        
<span class="c1">#         self.Q_dot = HeatConnector()</span>
        
<span class="c1">#         if HTX_Type == &#39;Plate&#39; or HTX_Type == &#39;Shell&amp;Tube&#39; or HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
<span class="c1">#             self.HTX_Type = HTX_Type</span>
<span class="c1">#         else:</span>
<span class="c1">#             print(&quot;Heat exchanger types implemented for this model are : &#39;Plate&#39;, &#39;Shell&amp;Tube&#39;, &#39;Tube&amp;Fins&#39;.&quot;)</span>

<span class="c1">#     def get_required_inputs(self):</span>
        
<span class="c1">#         if self.inputs == {}:</span>
<span class="c1">#             # Hot Fluid</span>
<span class="c1">#             if self.su[&#39;H&#39;].T is not None:</span>
<span class="c1">#                 self.inputs[&#39;Hsu_T&#39;] = self.su[&#39;H&#39;].T</span>
<span class="c1">#             elif self.su[&#39;H&#39;].h is not None:</span>
<span class="c1">#                 self.inputs[&#39;Hsu_h&#39;] = self.su[&#39;H&#39;].h</span>
<span class="c1">#             if self.su[&#39;H&#39;].p is not None:</span>
<span class="c1">#                 self.inputs[&#39;Hsu_p&#39;] = self.su[&#39;H&#39;].p</span>
<span class="c1">#             if self.su[&#39;H&#39;].fluid is not None:</span>
<span class="c1">#                 self.inputs[&#39;Hsu_fluid&#39;] = self.su[&#39;H&#39;].fluid</span>
<span class="c1">#             if self.su[&#39;H&#39;].m_dot is not None:</span>
<span class="c1">#                 self.inputs[&#39;Hsu_m_dot&#39;] = self.su[&#39;H&#39;].m_dot</span>
                
<span class="c1">#             # Cold Fluid                </span>
<span class="c1">#             if self.su[&#39;C&#39;].T is not None:</span>
<span class="c1">#                 self.inputs[&#39;Csu_T&#39;] = self.su[&#39;C&#39;].T</span>
<span class="c1">#             elif self.su[&#39;C&#39;].h is not None:</span>
<span class="c1">#                 self.inputs[&#39;Csu_h&#39;] = self.su[&#39;C&#39;].h</span>
<span class="c1">#             if self.su[&#39;C&#39;].p is not None:</span>
<span class="c1">#                 self.inputs[&#39;Csu_p&#39;] = self.su[&#39;C&#39;].p</span>
<span class="c1">#             if self.su[&#39;C&#39;].fluid is not None:</span>
<span class="c1">#                 self.inputs[&#39;Csu_fluid&#39;] = self.su[&#39;C&#39;].fluid</span>
<span class="c1">#             if self.su[&#39;C&#39;].m_dot is not None:</span>
<span class="c1">#                 self.inputs[&#39;Csu_m_dot&#39;] = self.su[&#39;C&#39;].m_dot</span>
                
<span class="c1">#         if self.inputs != {}:</span>
<span class="c1">#             # Hot Fluid</span>
<span class="c1">#             self.su[&#39;H&#39;].set_fluid(self.inputs[&#39;Hsu_fluid&#39;])</span>
<span class="c1">#             if &#39;Hsu_T&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;H&#39;].set_T(self.inputs[&#39;Hsu_T&#39;])</span>
<span class="c1">#             elif &#39;Hsu_h&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;H&#39;].set_h(self.inputs[&#39;Hsu_h&#39;])</span>
<span class="c1">#             if &#39;Hsu_p&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;H&#39;].set_p(self.inputs[&#39;Hsu_p&#39;])</span>
<span class="c1">#             if &#39;Hsu_m_dot&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;H&#39;].set_m_dot(self.inputs[&#39;Hsu_m_dot&#39;])</span>

<span class="c1">#             # Cold Fluid</span>
<span class="c1">#             self.su[&#39;C&#39;].set_fluid(self.inputs[&#39;Csu_fluid&#39;])</span>
<span class="c1">#             if &#39;Csu_T&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;C&#39;].set_T(self.inputs[&#39;Csu_T&#39;])</span>
<span class="c1">#             elif &#39;Csu_h&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;C&#39;].set_h(self.inputs[&#39;Csu_h&#39;])</span>
<span class="c1">#             if &#39;Csu_p&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;C&#39;].set_p(self.inputs[&#39;Csu_p&#39;])</span>
<span class="c1">#             if &#39;Csu_m_dot&#39; in self.inputs:</span>
<span class="c1">#                 self.su[&#39;C&#39;].set_m_dot(self.inputs[&#39;Csu_m_dot&#39;])</span>

<span class="c1">#         return [&#39;Hsu_p&#39;, &#39;Hsu_T&#39;, &#39;Hsu_m_dot&#39;, &#39;Hsu_fluid&#39;, &#39;Csu_p&#39;, &#39;Csu_T&#39;, &#39;Csu_m_dot&#39;, &#39;Csu_fluid&#39;]</span>

<span class="c1">#     def get_required_parameters(self):</span>
        
<span class="c1">#         general_parameters = [&#39;Flow_Type&#39;,&#39;htc_type&#39;, &#39;H_DP_ON&#39;, &#39;C_DP_ON&#39;,&#39;n_disc&#39;]</span>
        
<span class="c1">#         if self.HTX_Type == &#39;Plate&#39;:     </span>
<span class="c1">#             geometry_parameters = [&#39;A_c&#39;, &#39;A_h&#39;, &#39;h&#39;, &#39;l&#39;, &#39;l_v&#39;,</span>
<span class="c1">#                                    &#39;C_CS&#39;, &#39;C_Dh&#39;, &#39;C_V_tot&#39;, &#39;C_canal_t&#39;, &#39;C_n_canals&#39;,</span>
<span class="c1">#                                    &#39;H_CS&#39;, &#39;H_Dh&#39;, &#39;H_V_tot&#39;, &#39;H_canal_t&#39;, &#39;H_n_canals&#39;,</span>
<span class="c1">#                                    &#39;casing_t&#39;, &#39;chevron_angle&#39;, &#39;fooling&#39;, </span>
<span class="c1">#                                    &#39;n_plates&#39;, &#39;plate_cond&#39;, &#39;plate_pitch_co&#39;, &#39;t_plates&#39;, &#39;w&#39;]</span>

<span class="c1">#         elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
                
<span class="c1">#             geometry_parameters = [&#39;A_eff&#39;, &#39;Baffle_cut&#39;, &#39;D_OTL&#39;, &#39;N_strips&#39;, &#39;S_V_tot&#39;,</span>
<span class="c1">#                                    &#39;Shell_ID&#39;, &#39;T_V_tot&#39;, &#39;Tube_L&#39;, &#39;Tube_OD&#39;, &#39;Tube_pass&#39;,</span>
<span class="c1">#                                    &#39;Tube_t&#39;, &#39;Tubesheet_t&#39;, &#39;central_spacing&#39;, &#39;clear_BS&#39;, &#39;clear_TB&#39;,</span>
<span class="c1">#                                    &#39;cross_passes&#39;, &#39;foul_s&#39;, &#39;foul_t&#39;, &#39;inlet_spacing&#39;, &#39;n_series&#39;,</span>
<span class="c1">#                                    &#39;n_tubes&#39;, &#39;outlet_spacing&#39;, &#39;pitch_ratio&#39;, &#39;tube_cond&#39;, &#39;tube_layout&#39;, &#39;Shell_Side&#39;]</span>
        
<span class="c1">#         elif self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
            
<span class="c1">#             geometry_parameters = [&#39;A_eff&#39;, &#39;Baffle_cut&#39;, &#39;D_OTL&#39;, &#39;N_strips&#39;, &#39;S_V_tot&#39;,</span>
<span class="c1">#                                    &#39;Shell_ID&#39;, &#39;T_V_tot&#39;, &#39;Tube_L&#39;, &#39;Tube_OD&#39;, &#39;Tube_pass&#39;,</span>
<span class="c1">#                                    &#39;Tube_t&#39;, &#39;Tubesheet_t&#39;, &#39;central_spacing&#39;, &#39;clear_BS&#39;, &#39;clear_TB&#39;,</span>
<span class="c1">#                                    &#39;cross_passes&#39;, &#39;foul_s&#39;, &#39;foul_t&#39;, &#39;inlet_spacing&#39;, &#39;n_series&#39;,</span>
<span class="c1">#                                    &#39;n_tubes&#39;, &#39;outlet_spacing&#39;, &#39;pitch_ratio&#39;, &#39;tube_cond&#39;, &#39;tube_layout&#39;, &#39;Shell_Side&#39;]</span>
        
<span class="c1">#         return general_parameters + geometry_parameters</span>
    
<span class="c1">#     def print_setup(self):</span>
<span class="c1">#         print(&quot;=== Heat Exchanger Setup ===&quot;)</span>
<span class="c1">#         print(&quot;Connectors:&quot;)</span>
<span class="c1">#         print(f&quot;  - H_su: fluid={self.su[&#39;H&#39;].fluid}, T={self.su[&#39;H&#39;].T}, p={self.su[&#39;H&#39;].p}, m_dot={self.su[&#39;H&#39;].m_dot}&quot;)</span>
<span class="c1">#         print(f&quot;  - C_su: fluid={self.su[&#39;C&#39;].fluid}, T={self.su[&#39;C&#39;].T}, p={self.su[&#39;C&#39;].p}, m_dot={self.su[&#39;C&#39;].m_dot}&quot;)</span>

<span class="c1">#         print(&quot;\nInputs:&quot;)</span>
<span class="c1">#         for input in self.get_required_inputs():</span>
<span class="c1">#             if input in self.inputs:</span>
<span class="c1">#                 print(f&quot;  - {input}: {self.inputs[input]}&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(f&quot;  - {input}: Not set&quot;)</span>


<span class="c1">#         print(&quot;\nParameters:&quot;)</span>
<span class="c1">#         for param in self.get_required_parameters():</span>
<span class="c1">#             if param in self.params:</span>
<span class="c1">#                 print(f&quot;  - {param}: {self.params[param]}&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(f&quot;  - {param}: Not set&quot;)</span>

<span class="c1">#         print(&quot;======================&quot;)</span>
           
<span class="c1"># #%%</span>
<span class="c1">#     def set_HTC(self, htc_type = &quot;Correlation&quot;, Corr_H = None, Corr_C = None, UD_H_HTC = None, UD_C_HTC = None):</span>
        
<span class="c1">#         self.params[&#39;htc_type&#39;] = htc_type</span>
        
<span class="c1">#         self.check_calculable()</span>
        
<span class="c1">#         if htc_type == &quot;User-Defined&quot;:</span>
            
<span class="c1">#             self.H.HeatExchange_Correlation = &quot;User-Defined&quot;</span>
<span class="c1">#             self.C.HeatExchange_Correlation = &quot;User-Defined&quot;</span>
            
<span class="c1">#             # !!! User-Defined Heat Transfer Coefficients (hot):</span>
<span class="c1">#             self.H.h_liq = UD_H_HTC[&#39;Liquid&#39;]</span>
<span class="c1">#             self.H.h_vap = UD_H_HTC[&#39;Vapor&#39;]</span>
<span class="c1">#             self.H.h_twophase = UD_H_HTC[&#39;Two-Phase&#39;]</span>
<span class="c1">#             self.H.h_vapwet = UD_H_HTC[&#39;Vapor-wet&#39;]</span>
<span class="c1">#             self.H.h_tpdryout = UD_H_HTC[&#39;Dryout&#39;]</span>
<span class="c1">#             self.H.h_transcrit = UD_H_HTC[&#39;Transcritical&#39;]</span>
        
<span class="c1">#             # !!! User-Defined Heat Transfer Coefficients (cold):</span>
<span class="c1">#             self.C.h_liq = UD_C_HTC[&#39;Liquid&#39;]</span>
<span class="c1">#             self.C.h_vap = UD_C_HTC[&#39;Vapor&#39;]</span>
<span class="c1">#             self.C.h_twophase = UD_C_HTC[&#39;Two-Phase&#39;]</span>
<span class="c1">#             self.C.h_vapwet = UD_C_HTC[&#39;Vapor-wet&#39;]</span>
<span class="c1">#             self.C.h_tpdryout = UD_C_HTC[&#39;Dryout&#39;]</span>
<span class="c1">#             self.C.h_transcrit = UD_C_HTC[&#39;Transcritical&#39;]</span>
            
<span class="c1">#             if self.params[&#39;H_DP_ON&#39;] == True: # !!! arbitrarily set</span>
<span class="c1">#                 self.H.f_dp = {&quot;K&quot;: 14.14, &quot;B&quot;: 1.892}</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.H.f_dp = {&quot;K&quot;: 0, &quot;B&quot;: 0}</span>
                    
<span class="c1">#             if self.params[&#39;C_DP_ON&#39;] == True:</span>
<span class="c1">#                 self.C.f_dp = {&quot;K&quot;: 14.14, &quot;B&quot;: 1.892}</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.C.f_dp = {&quot;K&quot;: 0, &quot;B&quot;: 0}</span>
            
<span class="c1">#         else:</span>
<span class="c1">#             # Type </span>
<span class="c1">#             self.H.HeatExchange_Correlation = &quot;Correlation&quot;</span>
<span class="c1">#             self.C.HeatExchange_Correlation = &quot;Correlation&quot;</span>
            
<span class="c1">#             if self.HTX_Type == &#39;Plate&#39; or self.HTX_Type == &#39;Shell&amp;Tube&#39; or self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
                
<span class="c1">#                 self.H.Correlation_1phase = Corr_H[&quot;1P&quot;]</span>
<span class="c1">#                 self.H.Correlation_2phase = Corr_H[&quot;2P&quot;]</span>
                
<span class="c1">#                 self.C.Correlation_1phase = Corr_C[&quot;1P&quot;]</span>
<span class="c1">#                 self.C.Correlation_2phase = Corr_C[&quot;2P&quot;]</span>

<span class="c1">#                 if self.params[&#39;H_DP_ON&#39;] == True: # !!! arbitrarily set</span>
<span class="c1">#                     self.H.f_dp = {&quot;K&quot;: 14.14, &quot;B&quot;: 1.892}</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.H.f_dp = {&quot;K&quot;: 0, &quot;B&quot;: 0}        </span>
                    
<span class="c1">#                 if self.params[&#39;C_DP_ON&#39;] == True:</span>
<span class="c1">#                     self.C.f_dp = {&quot;K&quot;: 14.14, &quot;B&quot;: 1.892}</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.C.f_dp = {&quot;K&quot;: 0, &quot;B&quot;: 0}</span>
                    
<span class="c1">#             if self.C.Correlation_2phase == &quot;Boiling_curve&quot;:</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     T_sat = CP.PropsSI(&#39;T&#39;,&#39;P&#39;, self.su[&#39;C&#39;].p,&#39;Q&#39;,0,self.su[&#39;C&#39;].fluid)</span>
<span class="c1">#                     (h_boil, DT_vect) = boiling_curve(self.params[&#39;Tube_OD&#39;], self.su[&#39;C&#39;].fluid, T_sat, self.su[&#39;C&#39;].p)</span>
<span class="c1">#                     self.C_f_boiling = interp1d(DT_vect,h_boil)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     self.C_f_boiling = interp1d([0,10000],[20000,20000])</span>
            
<span class="c1"># #%%</span>
<span class="c1">#     def external_pinching(self):</span>
<span class="c1">#         &quot;Determine the maximum heat transfer rate based on the external pinching analysis&quot;</span>
        
<span class="c1">#         &quot;1) Set of arbitrary bound values&quot; # !!! Find out why      </span>
<span class="c1">#         T_hmin = 218 # above CO2 freezing point (194.7 K)</span>
            
<span class="c1">#         T_cmax = 273.15+250</span>
        
<span class="c1">#         &quot;2) Hot fluid side pinch&quot;</span>
        
<span class="c1">#         # Computation of outlet lowest possible enthalpy of the hot fluid using either the entrance cold fluid inlet temperature, or the arbitrary minimal</span>
<span class="c1">#         self.h_ho = CP.PropsSI(&#39;H&#39;,&#39;T&#39;, max(self.T_ci, T_hmin),&#39;P&#39;,self.p_hi,self.H_su.fluid) # Equation 5 (Bell et al. 2015)</span>
        
<span class="c1">#         # Q_max computation</span>
<span class="c1">#         Qmaxh = self.mdot_h*(self.h_hi-self.h_ho) # Equation 4 (Bell et al. 2015)</span>
        
<span class="c1">#         if debug:</span>
<span class="c1">#             print(&quot;Inlet Hot Enthalpy:&quot;, self.h_hi, &quot;\n&quot;)</span>
<span class="c1">#             print(&quot;Outlet Hot Enthalpy:&quot;, self.h_ho,&quot;\n&quot;)</span>
<span class="c1">#             print(&quot;mdot_h = &quot;, self.mdot_h, &quot;\n&quot;)</span>
<span class="c1">#             print(&quot;Qmaxh =&quot;, Qmaxh, &quot;\n&quot;)</span>

<span class="c1">#         &quot;3) Cold fluid side pinch&quot;</span>
                
<span class="c1">#         # Computation of highest possible outlet enthalpy of the hot fluid using either the entrance hot fluid inlet temperature, or the arbitrary maximal</span>
<span class="c1">#         self.h_co = CP.PropsSI(&#39;H&#39;,&#39;T&#39;,min(self.T_hi, T_cmax),&#39;P&#39;,self.p_ci,self.C_su.fluid) # Equation  (Bell et al. 2015)</span>
        
<span class="c1">#         # Q_max computation</span>
<span class="c1">#         Qmaxc = self.mdot_c*(self.h_co-self.h_ci) # Equation 6 (Bell et al. 2015)</span>

<span class="c1">#         if debug:</span>
<span class="c1">#             print(&quot;Inlet Cold Enthalpy:&quot;, self.h_ci, &quot;\n&quot;)</span>
<span class="c1">#             print(&quot;Outlet Cold Enthalpy:&quot;, self.h_co,&quot;\n&quot;)</span>
<span class="c1">#             print(&quot;mdot_c = &quot;, self.mdot_c, &quot;\n&quot;)</span>
<span class="c1">#             print(&quot;Qmaxh =&quot;, Qmaxc, &quot;\n&quot;)</span>
            
<span class="c1">#         &quot;4) Final pinch and cell boundaries computation&quot;</span>
        
<span class="c1">#         Qmax = min(Qmaxh, Qmaxc)</span>
        
<span class="c1">#         if debug:</span>
<span class="c1">#             print(&#39;Qmax (external pinching) is&#39;, Qmax)</span>

<span class="c1">#         self.calculate_cell_boundaries(Qmax) # call calculate_cell_boundaries procedure</span>

<span class="c1">#         return Qmax</span>
    
<span class="c1"># #%%</span>
<span class="c1">#     def calculate_cell_boundaries(self, Q):</span>
<span class="c1">#         &quot;&quot;&quot; Calculate the cell boundaries for each fluid &quot;&quot;&quot;</span>
        
<span class="c1">#         &quot;1) Re-calculate the outlet enthalpies of each stream&quot;</span>
                
<span class="c1">#         self.h_co = self.h_ci + Q/self.mdot_c</span>
<span class="c1">#         self.h_ho = self.h_hi - Q/self.mdot_h</span>

<span class="c1">#         &quot;2) Calculate the dew and bubble pressures and enthalpies by accounting for pressure drops&quot;</span>
        
<span class="c1">#         &quot;2.1) For the cold fluid&quot;</span>
        
<span class="c1">#         if not self.Transcritical_c: # if not in transcritical</span>
<span class="c1">#             if (not (self.C.f_dp == {&quot;K&quot;: 0, &quot;B&quot;: 0}) or self.DP_c &lt; 1e-2):</span>
<span class="c1">#                 # If no pressure drop is calculated or if the pressure drop is neglectable, assign saturation conditions to the ideal case:</span>
<span class="c1">#                 self.p_cdew = self.p_ci</span>
<span class="c1">#                 self.p_cbubble = self.p_co</span>
<span class="c1">#                 self.T_cbubble = self.T_cbubble_ideal</span>
<span class="c1">#                 self.T_cdew = self.T_cdew_ideal</span>
<span class="c1">#                 self.h_cbubble = self.h_cbubble_ideal</span>
<span class="c1">#                 self.h_cdew = self.h_cdew_ideal</span>
<span class="c1">#             else:</span>
<span class="c1">#                 h_cbubble, h_cdew, p_cbubble, p_cdew, _, _, = find_2P_boundaries(self.C_su.fluid, self.h_ci, self.h_co, self.p_ci, self.p_co)</span>
<span class="c1">#                 self.p_cdew = p_cdew</span>
<span class="c1">#                 self.p_cbubble = p_cbubble</span>
<span class="c1">#                 self.h_cdew = h_cdew</span>
<span class="c1">#                 self.h_cbubble = h_cbubble</span>
<span class="c1">#                 self.T_cdew = CP.PropsSI(&quot;T&quot;, &quot;P&quot;, self.p_cdew, &quot;Q&quot;, 1, self.C_su.fluid)</span>
<span class="c1">#                 self.T_cbubble = CP.PropsSI(&quot;T&quot;, &quot;P&quot;, self.p_cbubble, &quot;Q&quot;, 0, self.C_su.fluid)</span>
                
<span class="c1">#         &quot;2.2) For the hot fluid&quot;</span>
        
<span class="c1">#         if not self.Transcritical_h:</span>
<span class="c1">#             if (not (self.H.f_dp == {&quot;K&quot;: 0, &quot;B&quot;: 0}) or self.DP_h &lt; 1e-2) and not self.h_incomp_flag:</span>
<span class="c1">#                 #If no pressure drop is calculated or if the pressure drop is neglectable, assign saturation conditions to the ideal case:</span>
<span class="c1">#                 self.p_hdew = self.p_hi</span>
<span class="c1">#                 self.p_hbubble = self.p_ho    </span>
<span class="c1">#                 self.T_hbubble = self.T_hbubble_ideal</span>
<span class="c1">#                 self.T_hdew = self.T_hdew_ideal</span>
<span class="c1">#                 self.h_hbubble = self.h_hbubble_ideal</span>
<span class="c1">#                 self.h_hdew = self.h_hdew_ideal</span>
<span class="c1">#             elif not self.h_incomp_flag:</span>
<span class="c1">#                 h_hbubble, h_hdew, p_hdew, p_hbubble, _, _, = find_2P_boundaries(self.H_su.fluid, self.h_hi, self.h_ho, self.p_hi, self.p_ho)</span>
<span class="c1">#                 self.p_hdew = p_hdew</span>
<span class="c1">#                 self.p_hbubble = p_hbubble</span>
<span class="c1">#                 self.h_hdew = h_hdew</span>
<span class="c1">#                 self.h_hbubble = h_hbubble</span>
<span class="c1">#                 self.T_hdew = CP.PropsSI(&quot;T&quot;, &quot;P&quot;, self.p_hdew, &quot;Q&quot;, 1, self.H_su.fluid)</span>
<span class="c1">#                 self.T_hbubble = CP.PropsSI(&quot;T&quot;, &quot;P&quot;, self.p_hbubble, &quot;Q&quot;, 0, self.H_su.fluid)</span>

<span class="c1">#         &quot;3) Discretization of the heat exchanger, user defined&quot;</span>
<span class="c1">#         # The minimum number of cells desired is n_disc</span>
<span class="c1">#         # n_disc is increased by 1. Now it is the minimum number of cells boundaries.</span>
<span class="c1">#         n_disc = self.params[&#39;n_disc&#39;] + 1</span>
        
<span class="c1">#         # Force the minimum number of discretizations needed</span>
<span class="c1">#         n_disc = max(n_disc, 2)</span>
        
<span class="c1">#         # The original Bell2015 code uses: &quot;if h_cdew is not None&quot;. I don&#39;t see when that could happen without an error before.</span>
<span class="c1">#         &quot;3.1) Create a vector of enthalpies : initiates the cell boundaries. If phase change, dew and bubble point are added&quot;</span>
        
<span class="c1">#         # Cold side</span>
<span class="c1">#         if not self.Transcritical_c:</span>
<span class="c1">#             self.hvec_c = np.append(np.linspace(self.h_ci, self.h_co, n_disc), [self.h_cdew, self.h_cbubble])</span>
<span class="c1">#         elif self.Transcritical_c:</span>
<span class="c1">#             #In transcritical, just dont append the unexisting dew and bubble enthalpies</span>
<span class="c1">#             self.hvec_c = np.linspace(self.h_ci, self.h_co, n_disc)</span>
            
<span class="c1">#         self.hvec_c = np.sort(np.unique(self.hvec_c))</span>
<span class="c1">#         # Ensure that the enthalpy boundaries are all enclosed by the inlet and outlet conditions</span>
<span class="c1">#         self.hvec_c = [h for h in self.hvec_c if (h &gt;= self.h_ci and h &lt;= self.h_co)]</span>
        
<span class="c1">#         # Hot side</span>
<span class="c1">#         if not self.Transcritical_h and not self.h_incomp_flag:</span>
<span class="c1">#             self.hvec_h = np.append(np.linspace(self.h_hi, self.h_ho, n_disc), [self.h_hdew, self.h_hbubble])</span>
<span class="c1">#         elif self.Transcritical_h or self.h_incomp_flag:</span>
<span class="c1">#             #In transcritical, just dont append the unexisting dew and bubble enthalpies</span>
<span class="c1">#             self.hvec_h = np.linspace(self.h_hi, self.h_ho, n_disc)</span>
            
<span class="c1">#         self.hvec_h = np.sort(np.unique(self.hvec_h))</span>
<span class="c1">#         # Ensure that the enthalpy boundaries are all enclosed by the inlet and outlet conditions</span>
<span class="c1">#         self.hvec_h = [h for h in self.hvec_h if (h &gt;= self.h_ho and h &lt;= self.h_hi)]</span>

<span class="c1">#         &quot;4) Filling of the complementary cell boundaries&quot;</span>
        
<span class="c1">#         # Complementary cell boundaries serve to keep heat balances in check</span>
<span class="c1">#         # Start at the first element in the vector</span>
<span class="c1">#         k = 0</span>
<span class="c1">#         while k &lt; len(self.hvec_c)-1 or k &lt; len(self.hvec_h)-1:</span>
<span class="c1">#             if len(self.hvec_c) == 2 and len(self.hvec_h) == 2: # If there is only one cell</span>
<span class="c1">#                 break</span>

<span class="c1">#             # Determine which stream is the limiting next cell boundary</span>
<span class="c1">#             Qcell_hk = self.mdot_h*(self.hvec_h[k+1]-self.hvec_h[k])</span>
<span class="c1">#             Qcell_ck = self.mdot_c*(self.hvec_c[k+1]-self.hvec_c[k])</span>

<span class="c1">#             if debug:</span>
<span class="c1">#               print(&quot;k+1 Hot Enthalpy:&quot;, self.hvec_h[k+1], &quot;\n&quot;)</span>
<span class="c1">#               print(&quot;k Hot Enthalpy:&quot;, self.hvec_h[k],&quot;\n&quot;)</span>
<span class="c1">#               print(&quot;mdot_h = &quot;, self.mdot_h, &quot;\n&quot;)</span>
<span class="c1">#               print(&quot;Qcell_hk =&quot;, Qcell_hk, &quot;\n-------\n&quot;)</span>
<span class="c1">#               print(&quot;k+1 Cold Enthalpy:&quot;, self.hvec_c[k+1], &quot;\n&quot;)</span>
<span class="c1">#               print(&quot;k Cold Enthalpy:&quot;, self.hvec_c[k],&quot;\n&quot;)</span>
<span class="c1">#               print(&quot;mdot_c = &quot;, self.mdot_c, &quot;\n&quot;)</span>
<span class="c1">#               print(&quot;Qcell_hk =&quot;, Qcell_ck, &quot;\n-------\n&quot;)</span>

<span class="c1">#             if round(Qcell_hk, 4) &gt; round(Qcell_ck, 4):</span>
<span class="c1">#                 # Hot stream needs a complementary cell boundary as the available heat is higher than the cold cell heat absorption</span>
<span class="c1">#                 self.hvec_h.insert(k+1, self.hvec_h[k] + Qcell_ck/self.mdot_h)</span>
                
<span class="c1">#             elif round(Qcell_hk, 4) &lt; round(Qcell_ck, 4):</span>
<span class="c1">#                 # Cold stream needs a complementary cell boundary as the available heat absoprtion is higher than the hot cell heat </span>
<span class="c1">#                 self.hvec_c.insert(k+1, self.hvec_c[k] + Qcell_hk/self.mdot_c)</span>

<span class="c1">#             if debug:</span>
<span class="c1">#                 print(k,len(self.hvec_c),len(self.hvec_h),Qcell_hk, Qcell_ck)</span>

<span class="c1">#             # Increment index</span>
<span class="c1">#             k += 1</span>

<span class="c1">#         if debug:</span>
<span class="c1">#              print(&quot;Modified Length of hvec_c is &quot;, len(self.hvec_c))</span>
<span class="c1">#              print(&quot;Modified Length of hvec_h is &quot;, len(self.hvec_h))</span>

<span class="c1">#         assert(len(self.hvec_h) == len(self.hvec_c)) # Ensures that the two fluid streams have the same number of cell boundaries</span>

<span class="c1">#         # Calculate the vectors of exchanged heat in each cell.</span>
<span class="c1">#         self.Qvec_h = np.array([self.mdot_h*(self.hvec_h[i+1]-self.hvec_h[i]) for i in range(len(self.hvec_h)-1)])</span>
<span class="c1">#         self.Qvec_c = np.array([self.mdot_c*(self.hvec_c[i+1]-self.hvec_c[i]) for i in range(len(self.hvec_c)-1)])</span>

<span class="c1">#         if debug:</span>
<span class="c1">#             if np.max(np.abs(self.Qvec_c/self.Qvec_h))&lt;1e-5:</span>
<span class="c1">#                 print(self.Qvec_h, self.Qvec_c)</span>
            
<span class="c1">#         &quot;5) Computation of the thermal states at the cell boundaries&quot;</span>
        
<span class="c1">#         # Build the normalized enthalpy vectors (normalized by the total exchanged enthalpy)</span>
<span class="c1">#         self.hnorm_h = (np.array(self.hvec_h)-self.hvec_h[0])/(self.hvec_h[-1]-self.hvec_h[0])</span>
<span class="c1">#         self.hnorm_c = (np.array(self.hvec_c)-self.hvec_c[0])/(self.hvec_c[-1]-self.hvec_c[0])</span>

<span class="c1">#         # Pressure distribution accross the HX. Method by RDickes (not validated).</span>
<span class="c1">#         # Discretization of the pressure as a linear interpolation on enthalpy between in and out conditions # !!! Is this good ? </span>
<span class="c1">#         self.pvec_c = (1-self.hnorm_c)*self.p_ci + self.hnorm_c*self.p_co</span>
<span class="c1">#         self.pvec_h = (1-self.hnorm_h)*self.p_hi + self.hnorm_h*self.p_ho</span>

<span class="c1">#         # Calculate the temperature and entropy at each cell boundary</span>
<span class="c1">#         self.Tvec_c = CP.PropsSI(&#39;T&#39;,&#39;H&#39;,self.hvec_c,&#39;P&#39;,self.pvec_c,self.C_su.fluid)</span>
        
<span class="c1">#         self.Tvec_h = CP.PropsSI(&#39;T&#39;,&#39;H&#39;,self.hvec_h,&#39;P&#39;,self.pvec_h,self.H_su.fluid)</span>
<span class="c1">#         self.svec_h = CP.PropsSI(&#39;S&#39;,&#39;H&#39;,self.hvec_h,&#39;P&#39;,self.pvec_h,self.H_su.fluid)</span>
        
<span class="c1">#         self.svec_c = CP.PropsSI(&#39;S&#39;,&#39;H&#39;,self.hvec_c,&#39;P&#39;,self.pvec_c,self.C_su.fluid)</span>


<span class="c1">#         &quot;6) Vapour quality calculation if in the two-phase zone. If not, force, the value to -2 or 2&quot;</span>
<span class="c1">#         # Take Transcritical into account. in that Case, force x = 3</span>
        
<span class="c1">#         &quot;6.1) Hot Fluid&quot;</span>
<span class="c1">#         self.x_vec_h = []</span>
<span class="c1">#         for i, h_h in enumerate(self.hvec_h):</span>
<span class="c1">#             if not self.Transcritical_h and not self.h_incomp_flag:</span>
<span class="c1">#                 if h_h &lt; self.h_hbubble:</span>
<span class="c1">#                     self.x_vec_h.append(-2)        </span>
<span class="c1">#                 elif h_h &gt; self.h_hdew:</span>
<span class="c1">#                     self.x_vec_h.append(2)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.x_vec_h.append(min(1, max(0, (h_h - self.h_hbubble)/(self.h_hdew - self.h_hbubble))))</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.x_vec_h.append(3)</span>
                
<span class="c1">#         &quot;6.2) Cold Fluid&quot;</span>
<span class="c1">#         self.x_vec_c = []</span>
<span class="c1">#         for i, h_c in enumerate(self.hvec_c):</span>
<span class="c1">#             if not self.Transcritical_c:</span>
<span class="c1">#                 if h_c &lt; self.h_cbubble:</span>
<span class="c1">#                     self.x_vec_c.append(-2)        </span>
<span class="c1">#                 elif h_c &gt; self.h_cdew:</span>
<span class="c1">#                     self.x_vec_c.append(2)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.x_vec_c.append(min(1, max(0, (h_c - self.h_cbubble)/(self.h_cdew - self.h_cbubble))))</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.x_vec_c.append(3)</span>

<span class="c1">#         &quot;7) Vector of saturation temperatures at quality = 0.5, considering the pressure drop at each cell&quot;</span>
        
<span class="c1">#         if not self.Transcritical_c:</span>
<span class="c1">#             self.Tvec_sat_pure_c = CP.PropsSI(&quot;T&quot;, &quot;Q&quot;, 0.5, &quot;P&quot;, self.pvec_c, self.C_su.fluid)</span>
<span class="c1">#         if not self.Transcritical_h and not self.h_incomp_flag:</span>
<span class="c1">#             self.Tvec_sat_pure_h = CP.PropsSI(&quot;T&quot;, &quot;Q&quot;, 0.5, &quot;P&quot;, self.pvec_h, self.H_su.fluid)</span>
            
<span class="c1">#         &quot;8) Calculate pinch and heat exchanger border temperature deltas&quot;</span>
        
<span class="c1">#         self.DT_pinch = np.min((np.array(self.Tvec_h) - np.array(self.Tvec_c)))</span>
<span class="c1">#         self.DT_ho_ci = self.Tvec_h[0] - self.Tvec_c[0]</span>
<span class="c1">#         self.DT_hi_co = self.Tvec_h[-1] - self.Tvec_c[-1]</span>

<span class="c1"># #%%</span>
<span class="c1">#     def internal_pinching(self, stream):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Determine the maximum heat transfer rate based on the internal pinching analysis</span>
<span class="c1">#         NB : external pinching analysis has already been done</span>
<span class="c1">#         &quot;&quot;&quot;</span>
        
<span class="c1">#         # Try to find the dew point enthalpy as one of the cell boundaries</span>
<span class="c1">#         # that is not the inlet or outlet</span>
<span class="c1">#         # Do this only if the fluid is sub-critical</span>

<span class="c1">#         &quot;1) Check for the hot stream&quot;</span>
        
<span class="c1">#         if stream == &#39;hot&#39;:</span>
<span class="c1">#             if not self.Transcritical_h and not self.h_incomp_flag: # If the hot side is not transcritical</span>
<span class="c1">#                 for i in range(1,len(self.hvec_h)-1):</span>
                    
<span class="c1">#                     # Check if enthalpy is equal to the dewpoint enthalpy of hot stream and hot stream is colder than cold stream (impossible)</span>
<span class="c1">#                     if (abs(self.hvec_h[i] - self.h_hdew) &lt; 1e-6 and self.Tvec_c[i] &gt; self.Tvec_h[i]):</span>
                        
<span class="c1">#                         # Enthalpy of the cold stream at the pinch temperature</span>
<span class="c1">#                         h_c_pinch = CP.PropsSI(&#39;H&#39;,&#39;T&#39;,self.T_hdew,&#39;P&#39;,self.pvec_c[i], self.C_su.fluid) # Equation 10 (Bell et al. 2015)</span>

<span class="c1">#                         # Heat transfer in the cell</span>
<span class="c1">#                         Qright = self.mdot_h*(self.h_hi-self.h_hdew) # Equation 9 (Bell et al. 2015)</span>
                        
<span class="c1">#                         # New value for the limiting heat transfer rate</span>
<span class="c1">#                         Qmax = self.mdot_c*(h_c_pinch-self.h_ci) + Qright # Equation 12</span>

<span class="c1">#                         # Recalculate the cell boundaries</span>
<span class="c1">#                         self.calculate_cell_boundaries(Qmax)</span>
                
<span class="c1">#                         return Qmax</span>
                    
<span class="c1">#             elif self.Transcritical_h:</span>
<span class="c1">#                 #If the hot side is transcritical, do nothing</span>
<span class="c1">#                 pass</span>
            
<span class="c1">#             &quot;2) Check for the cold stream&quot;</span>
            
<span class="c1">#         elif stream == &#39;cold&#39;:</span>
<span class="c1">#             if not self.Transcritical_c:</span>
<span class="c1">#                 # Check for the cold stream pinch point</span>
<span class="c1">#                 for i in range(1,len(self.hvec_c)-1):</span>
                    
<span class="c1">#                     # Check if enthalpy is equal to the bubblepoint enthalpy of cold stream and hot stream is colder than cold stream (impossible)</span>
<span class="c1">#                     if (abs(self.hvec_c[i] - self.h_cbubble) &lt; 1e-6 and self.Tvec_c[i] &gt; self.Tvec_h[i]):</span>
                        
<span class="c1">#                         # Enthalpy of the cold stream at the pinch temperatur</span>
<span class="c1">#                         h_h_pinch = CP.PropsSI(&#39;H&#39;,&#39;T&#39;,self.T_cbubble,&#39;P&#39;,self.pvec_h[i], self.H_su.fluid) # Equation 14 (Bell et al. 2015)</span>

<span class="c1">#                         # Heat transfer in the cell</span>
<span class="c1">#                         Qleft = self.mdot_c*(self.h_cbubble-self.h_ci) # Equation 13 (Bell et al. 2015)</span>

<span class="c1">#                         # New value for the limiting heat transfer rate</span>
<span class="c1">#                         Qmax = Qleft + self.mdot_h*(self.h_hi-h_h_pinch) # Equation 16 (Bell et al. 2015)</span>

<span class="c1">#                         # Recalculate the cell boundaries</span>
<span class="c1">#                         self.calculate_cell_boundaries(Qmax)</span>

<span class="c1">#                         return Qmax</span>
                    
<span class="c1">#             elif self.Transcritical_c:</span>
<span class="c1">#                 #If the hot side is transcritical, do nothing</span>
<span class="c1">#                 pass</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError</span>
    
<span class="c1">#     #%%</span>
<span class="c1">#     def solve(self, only_external = False, and_solve = True):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Parameters</span>
<span class="c1">#         ----------</span>
<span class="c1">#             - mdot_h : Hot fluid flowrate [kg/s]</span>
<span class="c1">#             - p_hi : Hot fluid pressure [Pa]</span>
<span class="c1">#             - h_hi : Hot fluid specific enthalpy [J/kg]</span>
<span class="c1">#             - mdot_c : Cold fluid flowrate [kg/s]</span>
<span class="c1">#             - p_ci : Cold fluid pressure [Pa]</span>
<span class="c1">#             - h_ci : Cold fluid specific enthalpy [J/kg]</span>
<span class="c1">#             - only_external (optional) : calls only exxternal_pinching function to determine Q_dot max if set to True (if there is no phase change)</span>
<span class="c1">#             - and_solve (optional) : if set to true, solves the heat exchanger</span>

<span class="c1">#         Returns</span>
<span class="c1">#         -------</span>
<span class="c1">#             - Q : Exchanged heat rate [W]</span>

<span class="c1">#         &quot;&quot;&quot;</span>
        
<span class="c1">#         self.check_calculable()</span>
<span class="c1">#         self.check_parametrized()</span>
        
<span class="c1">#         if not self.calculable:</span>
<span class="c1">#             print(&quot;Component not calculable, check input&quot;)</span>
            
<span class="c1">#         if not self.parametrized:</span>
<span class="c1">#             print(&quot;Component not parametrized, check parameters&quot;)            </span>
            
<span class="c1">#         &quot;1) Main Input variables&quot;</span>
        
<span class="c1">#         self.H_su = self.su[&#39;H&#39;]</span>
<span class="c1">#         self.C_su = self.su[&#39;C&#39;]</span>
            
<span class="c1">#         self.H_ex = self.ex[&#39;H&#39;]</span>
<span class="c1">#         self.C_ex = self.ex[&#39;C&#39;]   </span>
            
<span class="c1">#         self.h_incomp_flag = (self.H_su.fluid.find(&quot;INCOMP&quot;) != -1)</span>
                
<span class="c1">#         # Hot fluid</span>
<span class="c1">#         self.mdot_h = self.H_su.m_dot</span>
<span class="c1">#         self.h_hi = self.H_su.h</span>
<span class="c1">#         self.p_hi = self.H_su.p</span>
        
<span class="c1">#         # Cold fluid </span>
<span class="c1">#         self.mdot_c = self.C_su.m_dot</span>
<span class="c1">#         self.h_ci = self.C_su.h</span>
<span class="c1">#         self.p_ci = self.C_su.p</span>
                
<span class="c1">#         # Determine the inlet temperatures from the pressure/enthalpy pairs</span>
<span class="c1">#         self.T_ci = CP.PropsSI(&#39;T&#39;, &#39;P&#39;, self.p_ci, &#39;H&#39;, self.h_ci, self.C_su.fluid)</span>
<span class="c1">#         self.T_hi = CP.PropsSI(&#39;T&#39;, &#39;P&#39;, self.p_hi, &#39;H&#39;, self.h_hi, self.H_su.fluid)</span>

<span class="c1">#         &quot;2) Determine if the streams come in at a higher pressure than the transcritical pressure&quot;</span>
        
<span class="c1">#         # Initialization of the flags:    </span>
<span class="c1">#         self.Transcritical_c = False</span>
<span class="c1">#         self.Transcritical_h = False</span>
        
<span class="c1">#         if not self.h_incomp_flag and (self.p_hi - CP.PropsSI(&quot;PCRIT&quot;, self.H_su.fluid)) &gt;= 1e-06:</span>
<span class="c1">#             self.Transcritical_h = True</span>

<span class="c1">#         &quot;3) Calculate the ideal bubble and dew temperatures/enthalpies for each stream IF the fluid is not transcritical&quot;</span>
        
        
<span class="c1">#         if not self.Transcritical_c:</span>
<span class="c1">#             self.T_cbubble_ideal = CP.PropsSI(&#39;T&#39;, &#39;P&#39;, self.p_ci, &#39;Q&#39;, 0, self.C_su.fluid)</span>
<span class="c1">#             self.T_cdew_ideal    = CP.PropsSI(&#39;T&#39;, &#39;P&#39;, self.p_ci, &#39;Q&#39;, 1, self.C_su.fluid)</span>
<span class="c1">#             self.h_cbubble_ideal = CP.PropsSI(&#39;H&#39;, &#39;T&#39;, self.T_cbubble_ideal, &#39;Q&#39;, 0, self.C_su.fluid)</span>
<span class="c1">#             self.h_cdew_ideal    = CP.PropsSI(&#39;H&#39;, &#39;T&#39;, self.T_cdew_ideal, &#39;Q&#39;, 1, self.C_su.fluid)  </span>
            
<span class="c1">#         if not self.Transcritical_h and not self.h_incomp_flag:</span>
<span class="c1">#             self.T_hbubble_ideal = CP.PropsSI(&#39;T&#39;, &#39;P&#39;, self.p_hi, &#39;Q&#39;, 0, self.H_su.fluid)</span>
<span class="c1">#             self.T_hdew_ideal    = CP.PropsSI(&#39;T&#39;, &#39;P&#39;, self.p_hi, &#39;Q&#39;, 1, self.H_su.fluid)</span>
<span class="c1">#             self.h_hbubble_ideal = CP.PropsSI(&#39;H&#39;, &#39;T&#39;, self.T_hbubble_ideal, &#39;Q&#39;, 0, self.H_su.fluid)</span>
<span class="c1">#             self.h_hdew_ideal    = CP.PropsSI(&#39;H&#39;, &#39;T&#39;, self.T_hdew_ideal, &#39;Q&#39;, 1, self.H_su.fluid)</span>
            
<span class="c1">#         &quot;4) Calculate pressure drops&quot;</span>
        
<span class="c1">#         if self.params[&#39;H_DP_ON&#39;] == True: # if the pressure drop are not neglected</span>
<span class="c1">#             if self.H_su.fluid == &#39;Water&#39;:</span>
<span class="c1">#                 self.DP_h = self.H.f_dp[&quot;K&quot;] * (self.mdot_h/self.H_su.D)**2</span>
<span class="c1">#                 self.p_ho = self.p_hi - self.DP_h</span>
<span class="c1">#             else:</span>
<span class="c1">#                 # rho_v = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,1,&#39;P&#39;,self.p_hi,self.H_su.fluid)</span>
<span class="c1">#                 # rho_l = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,0,&#39;P&#39;,self.p_hi,self.H_su.fluid)</span>
<span class="c1">#                 # mu_h = CP.PropsSI(&#39;V&#39;,&#39;H&#39;,self.h_hi,&#39;P&#39;,self.p_hi,self.H_su.fluid)</span>
                
<span class="c1">#                 # G_h = (self.mdot_h/self.geom.H_n_canals)/self.geom.H_CS</span>
<span class="c1">#                 self.DP_h = 0 # self.H.f_dp[&quot;K&quot;] * self.mdot_h**(self.H.f_dp[&quot;B&quot;]) # Empirical correlations : DP = K*m_dot**B # Han_BPHEX_DP(mu_h, G_h, self.geom.H_Dh, self.geom.chevron_angle, self.geom.plate_pitch_co, rho_v, rho_l, self.geom.l_v, self.geom.H_n_canals, self.mdot_h, self.geom.H_canal_t) # </span>
<span class="c1">#                 self.p_ho = self.p_hi - self.DP_h</span>
            
<span class="c1">#         if self.C.f_dp != {&quot;K&quot;: 0, &quot;B&quot;: 0}:</span>
<span class="c1">#             if self.C_su.fluid == &#39;Water&#39;:</span>
<span class="c1">#                 self.DP_c = self.C.f_dp[&quot;K&quot;] * (self.mdot_c/self.C_su.D)**2</span>
<span class="c1">#                 self.p_co = self.p_ci - self.DP_c</span>
<span class="c1">#             else:</span>
<span class="c1">#                 # rho_v = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,1,&#39;P&#39;,self.p_ci,self.C_su.fluid)</span>
<span class="c1">#                 # rho_l = CP.PropsSI(&#39;D&#39;,&#39;Q&#39;,0,&#39;P&#39;,self.p_ci,self.C_su.fluid)</span>
<span class="c1">#                 # mu_c = CP.PropsSI(&#39;V&#39;,&#39;H&#39;,self.h_ci,&#39;P&#39;,self.p_ci,self.C_su.fluid)               </span>
                
<span class="c1">#                 # G_c = (self.mdot_c/self.geom.C_n_canals)/self.geom.C_CS</span>
<span class="c1">#                 self.DP_c = 0 # self.C.f_dp[&quot;K&quot;] * self.mdot_c**(self.C.f_dp[&quot;B&quot;]) # Han_BPHEX_DP(mu_c, G_c, self.geom.H_Dh, self.geom.chevron_angle, self.geom.plate_pitch_co, rho_v, rho_l, self.geom.l_v, self.geom.C_n_canals, self.mdot_c, self.geom.C_canal_t) # </span>
<span class="c1">#                 self.p_co = self.p_ci - self.DP_c</span>
            
<span class="c1">#         &quot;5) Calculate maximum and actual heat rates&quot;</span>
        
<span class="c1">#         if (self.T_hi - self.T_ci) &gt; 1e-2  and self.mdot_h  &gt; 0 and self.mdot_c &gt; 0: # Check that the operating conditions allow for heat transfer</span>
            
<span class="c1">#             &quot;5.1) Compute the external pinching &amp; update cell boundaries&quot;</span>
<span class="c1">#             Qmax_ext = self.external_pinching() # Call to external-pinching procedure</span>
<span class="c1">#             self.Qmax_ext = Qmax_ext</span>
<span class="c1">#             Qmax = Qmax_ext</span>
            
<span class="c1">#             if debug:</span>
<span class="c1">#                 print(&quot;External pinching calculation done. \n&quot;)</span>
            
<span class="c1">#             &quot;5.2) Compute the internal pinching &amp; update cell boundaries&quot;</span>
<span class="c1">#             if not only_external: # If phase change is expected : Check the internal pinching</span>
<span class="c1">#                 for stream in [&#39;hot&#39;,&#39;cold&#39;]:</span>
<span class="c1">#                     Qmax_int = self.internal_pinching(stream) # Call to internal-pinching procedure</span>
<span class="c1">#                     if Qmax_int is not None:</span>
<span class="c1">#                         self.Qmax_int = Qmax_int</span>
<span class="c1">#                         Qmax = Qmax_int</span>
            
<span class="c1">#             # Maximum heat transfer rate determined by external or internal pinching</span>
<span class="c1">#             self.Qmax = Qmax</span>
            
<span class="c1">#             &quot;5.3) Solve the heat exchanger to find the actual heat rate&quot;</span>
<span class="c1">#             if and_solve and not only_external:</span>
<span class="c1">#                 Q = self.solve_HX()</span>

<span class="c1">#             self.epsilon_th = self.Q/self.Qmax # HTX efficiency</span>
<span class="c1">#             self.residual = 1 - sum(self.w) # HTX residual # !!! (what is &quot;w&quot; ?)</span>
            
<span class="c1">#             &quot;5.4) Effective density computation for each cell taking into account void fraction&quot;</span>
            
<span class="c1">#             self.Dvec_h = np.empty(len(self.hvec_h))</span>
<span class="c1">#             self.Dvec_c = np.empty(len(self.hvec_c))</span>
            
<span class="c1">#             # Cross section void fraction : considered constant along each discretization in the void_fraction function</span>
<span class="c1">#             self.eps_void_h = np.empty(len(self.hvec_c)) </span>
<span class="c1">#             self.eps_void_c = np.empty(len(self.hvec_c))</span>
            
<span class="c1">#             for i in range(len(self.hvec_h)):</span>
<span class="c1">#                 if self.x_vec_h[i] &lt;= 0 or self.x_vec_h[i] &gt;= 1: </span>
<span class="c1">#                     self.Dvec_h[i] = CP.PropsSI(&#39;D&#39;, &quot;P&quot;, self.pvec_h[i], &quot;H&quot;, self.hvec_h[i], self.H_su.fluid)</span>
<span class="c1">#                     self.eps_void_h[i] = -1</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     rho_g = CP.PropsSI(&#39;D&#39;, &#39;P&#39;, self.pvec_h[i], &quot;Q&quot;, 1, self.H_su.fluid)</span>
<span class="c1">#                     rho_l = CP.PropsSI(&#39;D&#39;, &#39;P&#39;, self.pvec_h[i], &quot;Q&quot;, 0, self.H_su.fluid)</span>
<span class="c1">#                     self.eps_void_h[i], self.Dvec_h[i] = void_fraction(self.x_vec_h[i], rho_g, rho_l)</span>
                    
<span class="c1">#             for i in range(len(self.hvec_c)-1):</span>
<span class="c1">#                 if self.x_vec_c[i] &lt;= 0 or self.x_vec_c[i] &gt;= 1: </span>
<span class="c1">#                     self.Dvec_c[i] = CP.PropsSI(&#39;D&#39;, &quot;P&quot;, self.pvec_c[i], &quot;H&quot;, self.hvec_c[i], self.C_su.fluid)</span>
<span class="c1">#                     self.eps_void_c[i] = -1</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     rho_g = CP.PropsSI(&#39;D&#39;, &#39;P&#39;, self.pvec_c[i], &quot;Q&quot;, 1, self.C_su.fluid)</span>
<span class="c1">#                     rho_l = CP.PropsSI(&#39;D&#39;, &#39;P&#39;, self.pvec_c[i], &quot;Q&quot;, 0, self.C_su.fluid)</span>
<span class="c1">#                     self.eps_void_c[i], self.Dvec_c[i] = void_fraction(self.x_vec_c[i], rho_g, rho_l)</span>
            
<span class="c1">#             &quot;5.5) Computation of the fluid mass inside the HTX&quot;</span>
            
<span class="c1">#             if self.HTX_Type == &#39;Plate&#39;:</span>
<span class="c1">#                 self.Vvec_h = self.params[&#39;H_V_tot&#39;]*np.array(self.w) # !!! Attention to this assumption</span>
<span class="c1">#                 self.Vvec_c = self.params[&#39;C_V_tot&#39;]*np.array(self.w)</span>

<span class="c1">#             elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
<span class="c1">#                 if self.params[&#39;Shell_Side&#39;] == &#39;H&#39;: # Shell Side is the hot side</span>
<span class="c1">#                     self.Vvec_h = self.params[&#39;S_V_tot&#39;]*np.array(self.w) # !!! Attention to this assumption</span>
<span class="c1">#                     self.Vvec_c = self.params[&#39;T_V_tot&#39;]*np.array(self.w)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.Vvec_h = self.params[&#39;T_V_tot&#39;]*np.array(self.w) # !!! Attention to this assumption</span>
<span class="c1">#                     self.Vvec_c = self.params[&#39;S_V_tot&#39;]*np.array(self.w)                    </span>

<span class="c1">#             elif self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
<span class="c1">#                 if self.params[&#39;Fin_Side&#39;] == &#39;H&#39;: # Shell Side is the hot side</span>
<span class="c1">#                     self.Vvec_h = self.params[&#39;B_V_tot&#39;]*np.array(self.w) # !!! Attention to this assumption</span>
<span class="c1">#                     self.Vvec_c = self.params[&#39;T_V_tot&#39;]*np.array(self.w)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.Vvec_h = self.params[&#39;T_V_tot&#39;]*np.array(self.w) # !!! Attention to this assumption</span>
<span class="c1">#                     self.Vvec_c = self.params[&#39;B_V_tot&#39;]*np.array(self.w) </span>
                
<span class="c1">#             # Initiates the mass vectors # !!! (for each cell ?)</span>
<span class="c1">#             self.Mvec_h = np.empty(len(self.hvec_h)-1)</span>
<span class="c1">#             self.Mvec_c = np.empty(len(self.hvec_c)-1)</span>
            
<span class="c1">#             # Mass computation # Volume*Mean of the densities at the cell boundaries</span>
<span class="c1">#             for i in range(len(self.hvec_h)-1):</span>
<span class="c1">#                 self.Mvec_h[i] = self.Vvec_h[i]*(self.Dvec_h[i] + self.Dvec_h[i+1])/2</span>
<span class="c1">#                 self.Mvec_c[i] = self.Vvec_c[i]*(self.Dvec_c[i] + self.Dvec_c[i+1])/2</span>

<span class="c1">#             if and_solve:</span>
                
<span class="c1">#                 # Hot side</span>
<span class="c1">#                 self.ex[&#39;H&#39;].set_fluid(self.H_su.fluid)</span>
<span class="c1">#                 self.ex[&#39;H&#39;].set_T(self.Tvec_h[0])</span>
<span class="c1">#                 self.ex[&#39;H&#39;].set_p(self.pvec_h[0])</span>
<span class="c1">#                 self.ex[&#39;H&#39;].set_m_dot(self.H_su.m_dot)</span>
                
<span class="c1">#                 self.H_ex = self.ex[&#39;H&#39;]</span>
                    
<span class="c1">#                 # Cold side</span>
<span class="c1">#                 self.ex[&#39;C&#39;].set_fluid(self.C_su.fluid)</span>
<span class="c1">#                 self.ex[&#39;C&#39;].set_T(self.Tvec_c[-1]) # Example temperature [K]</span>
<span class="c1">#                 self.ex[&#39;C&#39;].set_p(self.pvec_c[-1]) # Example Pressure [Pa]</span>
<span class="c1">#                 self.ex[&#39;C&#39;].set_m_dot(self.C_su.m_dot) </span>
        
<span class="c1">#                 self.C_ex = self.ex[&#39;C&#39;]</span>
                                            
<span class="c1">#                 self.defined = True</span>
<span class="c1">#                 return Q</span>
            
<span class="c1">#         else: # Just a flag if the heat exchanger is not solved</span>
<span class="c1">#             self.Q = 1</span>
            
<span class="c1"># #%%    </span>
<span class="c1">#     def objective_function(self, Q):</span>
        
<span class="c1">#         &quot;1) Initialize cell boundaries and results vectors&quot;</span>
        
<span class="c1">#         # Cell boundaries</span>
<span class="c1">#         self.calculate_cell_boundaries(Q)</span>

<span class="c1">#         # Initialize dry-out incipience identification</span>
<span class="c1">#         self.x_di_c = 1</span>
<span class="c1">#         self.dry_out_c = False</span>
<span class="c1">#         self.ColdSide_Props_Calculated = False</span>
        
<span class="c1">#         # Initialise results arrays</span>
<span class="c1">#         w = [] # The wet-bulb potential temperature</span>
<span class="c1">#         self.Avec_h = []</span>
<span class="c1">#         self.alpha_c = []</span>
<span class="c1">#         self.alpha_h = []</span>
<span class="c1">#         self.phases_h = []</span>
<span class="c1">#         self.phases_c = []</span>

<span class="c1">#         &quot;2) Iteration over all cells&quot;</span>
        
<span class="c1">#         # The length of the hvec vectors is the same. hvec_h is arbitrarily taken below</span>
<span class="c1">#         for k in range(len(self.hvec_h)-1): # iterate over each cell</span>
            
<span class="c1">#             &quot;2.1) Diverse temperature parameter definition&quot;</span>
            
<span class="c1">#             Thi = self.Tvec_h[k+1] </span>
<span class="c1">#             Tci = self.Tvec_c[k]</span>
<span class="c1">#             Tho = self.Tvec_h[k]</span>
<span class="c1">#             Tco = self.Tvec_c[k+1]</span>
            
<span class="c1">#             DTA = max(Thi - Tco, 1e-02)</span>
<span class="c1">#             DTB = max(Tho - Tci, 1e-02)</span>
            
<span class="c1">#             if DTA == DTB:</span>
<span class="c1">#                 LMTD = DTA</span>
<span class="c1">#             else:</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     LMTD = (DTA-DTB)/np.log(abs(DTA/DTB))</span>
<span class="c1">#                 except ValueError as VE:</span>
<span class="c1">#                     print(Q, DTA, DTB)</span>
<span class="c1">#                     raise</span>
            
<span class="c1">#             # Wall Temperature:</span>
<span class="c1">#             T_wall = (Thi + Tho + Tci + Tco)/4</span>
            
<span class="c1">#             # Cold side</span>
<span class="c1">#             Tc_mean = 0.5*(Tci + Tco) # mean temperature over the cell</span>
            
<span class="c1">#             if not self.Transcritical_c:</span>
<span class="c1">#                 Tc_sat_mean = 0.5*(self.Tvec_sat_pure_c[k] + self.Tvec_sat_pure_c[k+1]) # mean saturation temperature over the cell</span>
                
<span class="c1">#             p_c_mean = 0.5*(self.pvec_c[k] + self.pvec_c[k+1]) # mean pressure over the cell</span>
            
<span class="c1">#             # Hot side</span>
<span class="c1">#             Th_mean = 0.5*(Thi + Tho) # mean temperature over the cell</span>
            
<span class="c1">#             if not self.Transcritical_h and not self.h_incomp_flag:</span>
<span class="c1">#                 Th_sat_mean = 0.5*(self.Tvec_sat_pure_h[k] + self.Tvec_sat_pure_h[k+1]) # mean saturation temperature over the cell</span>
            
<span class="c1">#             p_h_mean = 0.5*(self.pvec_h[k] + self.pvec_h[k+1]) # mean pressure over the cell</span>

<span class="c1">#             &quot;2.2) Hot side phase identification&quot;</span>
            
<span class="c1">#             # If not transcritical</span>
<span class="c1">#             if not self.Transcritical_h and not self.h_incomp_flag:</span>
                
<span class="c1">#                 havg_h = (self.hvec_h[k] + self.hvec_h[k+1])/2.0 # Average cell enthalpy over the cell</span>
                
<span class="c1">#                 if havg_h &lt; self.h_hbubble: # below evaporation/bubble point</span>
<span class="c1">#                     self.phases_h.append(&#39;liquid&#39;)</span>
<span class="c1">#                     T_wall_h = T_wall</span>
                    
<span class="c1">#                 elif havg_h &gt; self.h_hdew: # higher than condensation/dew point</span>
<span class="c1">#                     #T_wall_h not used so far but it could appear in future Correlations implemented.</span>
<span class="c1">#                     T_wall_h = max(T_wall, Th_sat_mean)</span>
                    
<span class="c1">#                     if T_wall &gt; Th_sat_mean:</span>
<span class="c1">#                         self.phases_h.append(&#39;vapor&#39;)</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         self.phases_h.append(&#39;vapor-wet&#39;)</span>
                        
<span class="c1">#                 else: # Between evaporation/bubble and condensation/dew point</span>
<span class="c1">#                     self.phases_h.append(&#39;two-phase&#39;)</span>
<span class="c1">#                     T_wall_h = T_wall</span>
                    
<span class="c1">#             elif self.h_incomp_flag:</span>
<span class="c1">#                 self.phases_h.append(&#39;liquid&#39;)</span>
<span class="c1">#                 T_wall_h = T_wall</span>
                
<span class="c1">#             elif self.Transcritical_h:</span>
<span class="c1">#                 self.phases_h.append(&quot;transcritical&quot;)</span>
<span class="c1">#                 T_wall_h = T_wall</span>
            
<span class="c1">#             &quot;2.3) Cold side phase identification&quot;</span>

<span class="c1">#             # If not transcritical</span>
<span class="c1">#             if not self.Transcritical_c:</span>
                
<span class="c1">#                 havg_c = (self.hvec_c[k] + self.hvec_c[k+1])/2.0 # Average cell enthalpy over the cell</span>
                
<span class="c1">#                 if havg_c &lt; self.h_cbubble: # below evaporation/bubble point</span>
<span class="c1">#                     self.phases_c.append(&#39;liquid&#39;)</span>
<span class="c1">#                     #The line comented below is the original line on the code. It is causing trouble.</span>
<span class="c1">#                     #T_wall_c = min(T_wall, Tc_sat_mean)</span>
<span class="c1">#                     T_wall_c = T_wall</span>
                    
<span class="c1">#                 elif havg_c &gt; self.h_cdew: # higher than condensation/dew point</span>
<span class="c1">#                     self.phases_c.append(&quot;vapor&quot;)</span>
<span class="c1">#                     T_wall_c = T_wall</span>
                    
<span class="c1">#                 else: # Between evaporation/bubble and condensation/dew point</span>
<span class="c1">#                     T_wall_c = T_wall</span>
                    
<span class="c1">#                     if (0.5*self.x_vec_c[k] + 0.5*self.x_vec_c[k+1]) &lt;= self.x_di_c:</span>
<span class="c1">#                         self.phases_c.append(&#39;two-phase&#39;)  </span>
                        
<span class="c1">#                     else:</span>
<span class="c1">#                         self.phases_c.append(&quot;two-phase-dryout&quot;)</span>
<span class="c1">#                         self.dry_out_c = True</span>
                        
<span class="c1">#             elif self.Transcritical_c:</span>
<span class="c1">#                 self.phase_c.append(&#39;transcritical&#39;)</span>
            
<span class="c1">#             if self.HTX_Type == &#39;Plate&#39;:                </span>
<span class="c1">#                 G_c = (self.mdot_c/self.params[&#39;C_n_canals&#39;])/self.params[&#39;C_CS&#39;]</span>
<span class="c1">#                 G_h = (self.mdot_h/self.params[&#39;H_n_canals&#39;])/self.params[&#39;H_CS&#39;]</span>
                
<span class="c1">#             elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
<span class="c1">#                 A_in_one_tube = np.pi*((self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;])/2)**2</span>
            
<span class="c1">#                 # Mass flow in tubes if the fluid is in the tubes</span>
<span class="c1">#                 G_h = (self.mdot_h/self.params[&#39;n_tubes&#39;])/A_in_one_tube</span>
<span class="c1">#                 G_c = (self.mdot_c/self.params[&#39;n_tubes&#39;])/A_in_one_tube</span>

<span class="c1">#             elif self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
<span class="c1">#                 A_in_one_tube = np.pi*((self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;])/2)**2</span>
            
<span class="c1">#                 # Mass flow in tubes if the fluid is in the tubes</span>
<span class="c1">#                 G_h = (self.mdot_h/self.params[&#39;n_tubes&#39;])/A_in_one_tube</span>
<span class="c1">#                 G_c = (self.mdot_c/self.params[&#39;n_tubes&#39;])/A_in_one_tube</span>
                
<span class="c1">#             # F correction factor for LMTD method:</span>
<span class="c1">#             if self.params[&#39;Flow_Type&#39;] != &quot;CounterFlow&quot;:</span>
                
<span class="c1">#                 try:</span>
<span class="c1">#                     C_c = CP.PropsSI(&#39;C&#39;, &#39;T&#39;, Tc_mean,&#39;P&#39;,p_c_mean,self.C_su.fluid)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     C_c = 20000</span>
                    
<span class="c1">#                 try:</span>
<span class="c1">#                     C_h = CP.PropsSI(&#39;C&#39;, &#39;T&#39;, Th_mean,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     C_h = 20000</span>
                
<span class="c1">#                 C_min = min(C_c,C_h)</span>
<span class="c1">#                 C_max = max(C_c,C_h)</span>
                
<span class="c1">#                 C_r = C_min/C_max</span>
                
<span class="c1">#                 self.R = (Thi - Tho)/(Tco - Tci)</span>
<span class="c1">#                 self.P = (Tco - Tci)/(Thi - Tci)</span>
<span class="c1">#                 self.F = f_lmtd2(self.R, self.P, self.params, C_r)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.F = 1</span>
            
<span class="c1">#             #UA_req including F correction factor in case of cross flow</span>
<span class="c1">#             UA_req = self.mdot_h*(self.hvec_h[k+1]-self.hvec_h[k])/(self.F*LMTD)          </span>
            
<span class="c1">#             &quot;3) Cell heat transfer coefficients&quot;</span>
            
<span class="c1">#             &quot;3.1) Hot side - User defined&quot;</span>
            
<span class="c1">#             if self.H.HeatExchange_Correlation == &quot;User-Defined&quot;:</span>
<span class="c1">#                 if self.phases_h[k] == &quot;liquid&quot;:</span>
<span class="c1">#                     alpha_h = self.H.h_liq</span>
<span class="c1">#                 elif self.phases_h[k] == &quot;vapor&quot;:</span>
<span class="c1">#                     alpha_h = self.H.h_vap</span>
<span class="c1">#                 elif self.phases_h[k] == &quot;two-phase&quot;:</span>
<span class="c1">#                     alpha_h = self.H.h_twophase</span>
<span class="c1">#                 elif self.phases_h[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                     alpha_h = self.H.h_vapwet</span>
<span class="c1">#                 elif self.phases_h[k] == &quot;two-phase-dryout&quot;:</span>
<span class="c1">#                     alpha_h = self.H.h_tpdryout</span>
<span class="c1">#                 elif self.phases_h[k] == &quot;transcritical&quot;:</span>
<span class="c1">#                     alpha_h = self.H.h_transcrit</span>
                    
<span class="c1">#             elif self.H.HeatExchange_Correlation == &quot;Correlation&quot;: </span>
                
<span class="c1">#                 # Heat transfer coefficient calculated from Correlations.</span>
<span class="c1">#                 # Evaluate phases</span>
                
<span class="c1">#                 # 1 phase case</span>
<span class="c1">#                 if self.phases_h[k] == &quot;liquid&quot; or self.phases_h[k] == &quot;vapor&quot; or self.phases_h[k] == &quot;transcritical&quot;:</span>
                                        
<span class="c1">#                     if self.H.Correlation_1phase == &quot;Gnielinski&quot;:</span>
<span class="c1">#                         try:</span>
<span class="c1">#                             mu_h, Pr_h, k_h, mu_wall, mu_rat, _, _ = propsfluid(Th_mean, p_h_mean, T_wall_h, self.H_su.fluid, False)</span>
<span class="c1">#                             Pr_h_w, mu_h_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, Th_mean,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>
<span class="c1">#                         except (ValueError):</span>
<span class="c1">#                             if self.phases_h[k] == &quot;liquid&quot;:</span>
<span class="c1">#                                 mu_h, Pr_h, k_h, mu_wall, mu_rat, _, _ = propsfluid(Th_mean-0.1, p_h_mean, T_wall_h, self.H_su.fluid, False)</span>
<span class="c1">#                                 Pr_h_w, mu_h_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, Th_mean-1,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>
<span class="c1">#                             elif self.phases_h[k] == &quot;vapor&quot;:</span>
<span class="c1">#                                 mu_h, Pr_h, k_h, mu_wall, mu_rat, _, _ = propsfluid(Th_mean+0.1, p_h_mean, T_wall_h, self.H_su.fluid, False)</span>
<span class="c1">#                                 Pr_h_w, mu_h_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, Th_mean+1,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>

<span class="c1">#                         if self.HTX_Type == &#39;Plate&#39;:</span>
<span class="c1">#                             alpha_h = gnielinski_pipe_htc(mu_h, Pr_h, Pr_h_w, k_h, G_h, self.params[&#39;H_Dh&#39;], self.params[&#39;l&#39;]) # Muley_Manglik_BPHEX_HTC(mu_h, mu_h_w, Pr_h, k_h, G_h, self.geom.H_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_h, Pr_h, k_h, G_h, self.geom.H_Dh) # </span>
                        
<span class="c1">#                         elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
<span class="c1">#                             alpha_h = gnielinski_pipe_htc(mu_h, Pr_h, Pr_h_w, k_h, G_h, self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;], self.params[&#39;Tube_L&#39;]) # Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                        
<span class="c1">#                         elif self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
<span class="c1">#                             alpha_h = gnielinski_pipe_htc(mu_h, Pr_h, Pr_h_w, k_h, G_h, self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;], self.params[&#39;Tube_L&#39;]*self.params[&#39;n_passes&#39;]) # Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                    
<span class="c1">#                     elif self.H.Correlation_1phase == &quot;Shell_Bell_Delaware_HTC&quot;:</span>
<span class="c1">#                         alpha_h = shell_bell_delaware_htc(self.mdot_h, Th_mean, T_wall, p_h_mean, self.H_su.fluid, self.params)</span>
                        
<span class="c1">#                     elif self.H.Correlation_1phase == &#39;Tube_And_Fins&#39;:</span>
<span class="c1">#                         alpha_h = htc_tube_and_fins(self.H_su.fluid, self.params, p_h_mean, Th_mean, self.mdot_h, self.params[&#39;Fin_type&#39;])[0]</span>
                        
<span class="c1">#                 # 2 phases case</span>
<span class="c1">#                 elif self.phases_h[k] == &quot;two-phase&quot; or self.phases_h[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                     if self.phases_h[k] == &quot;two-phase&quot;:</span>
<span class="c1">#                         x_h = min(1, max(0, 0.5*(self.x_vec_h[k] + self.x_vec_h[k])))</span>
<span class="c1">#                     elif self.phases_h[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                         x_h = 1</span>
                    
<span class="c1">#                     # Thermodynamical variables</span>
<span class="c1">#                     mu_h_l = CP.PropsSI(&quot;V&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_h_mean, self.H_su.fluid)</span>
<span class="c1">#                     k_h_l = CP.PropsSI(&quot;L&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_h_mean, self.H_su.fluid)</span>
<span class="c1">#                     Pr_h_l = CP.PropsSI(&quot;Prandtl&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_h_mean, self.H_su.fluid)</span>
<span class="c1">#                     rho_h_l = CP.PropsSI(&quot;D&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_h_mean, self.H_su.fluid)</span>
<span class="c1">#                     rho_h_v = CP.PropsSI(&quot;D&quot;, &quot;Q&quot;, 1, &quot;P&quot;, p_h_mean, self.H_su.fluid)</span>
<span class="c1">#                     # i_fg_h = CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 1, &#39;P&#39;, p_h_mean, self.H_su.fluid) - CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 0, &#39;P&#39;, p_h_mean, self.H_su.fluid)</span>
                    
<span class="c1">#                     # !!! Include different types of Correlation HERE</span>
<span class="c1">#                     if self.H.Correlation_2phase == &quot;Han_cond_BPHEX&quot;:</span>
<span class="c1">#                         alpha_h_2phase, _, DP_H = han_cond_BPHEX_HTC(x_h, mu_h_l, k_h_l, Pr_h_l, rho_h_l, rho_h_v, G_h, self.params[&#39;H_Dh&#39;], self.params[&#39;plate_pitch_co&#39;], self.params[&#39;chevron_angle&#39;], self.params[&#39;l_v&#39;], self.params[&#39;H_n_canals&#39;], self.H_su.m_dot, self.params[&#39;H_canal_t&#39;])</span>
                    
<span class="c1">#                     if self.H.Correlation_2phase == &#39;ext_tube_film_condens&#39;:</span>
<span class="c1">#                         V_flow = G_h/CP.PropsSI(&#39;D&#39;,&#39;H&#39;,havg_h,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>
                        
<span class="c1">#                         if self.H.Correlation_1phase == &quot;Shell_Bell_Delaware_HTC&quot;:</span>
<span class="c1">#                             alpha_h = shell_bell_delaware_htc(self.mdot_h, Th_mean, T_wall, p_h_mean, self.H_su.fluid, self.params)</span>
                            
<span class="c1">#                         elif self.H.Correlation_1phase == &#39;Tube_And_Fins&#39;:</span>
<span class="c1">#                             alpha_h = htc_tube_and_fins(self.C_su.fluid, self.params, p_c_mean, Tc_mean, self.mdot_c, self.params[&#39;Fin_type&#39;])[0]</span>
                            
<span class="c1">#                         alpha_h_2phase = ext_tube_film_condens(self.params[&#39;Tube_OD&#39;], self.H_su.fluid, Th_mean, T_wall, V_flow)</span>
                        
<span class="c1">#                     if self.H.Correlation_2phase == &#39;Horizontal_Tube_Internal_Condensation&#39;:</span>
<span class="c1">#                         mu_h, Pr_h, k_h = CP.PropsSI((&#39;V&#39;,&#39;PRANDTL&#39;,&#39;L&#39;), &#39;H&#39;, havg_h,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>
<span class="c1">#                         Pr_h_w, mu_h_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, T_wall,&#39;P&#39;,p_h_mean,self.H_su.fluid)</span>
                                
<span class="c1">#                         alpha_h = gnielinski_pipe_htc(mu_h, Pr_h, Pr_h_w, k_h, G_h, self.params[&#39;Tube_OD&#39;] - 2*self.params[&#39;Tube_t&#39;], self.params[&#39;Tube_L&#39;])</span>
<span class="c1">#                         alpha_h_2phase = horizontal_tube_internal_condensation(self.H_su.fluid , G_c, p_h_mean, self.x_vec_h[k], T_wall, self.params[&#39;Tube_OD&#39;] - 2*self.params[&#39;Tube_t&#39;])</span>
                                        
<span class="c1">#                     if self.phases_h[k] == &quot;two-phase&quot;:</span>
<span class="c1">#                         alpha_h = alpha_h_2phase</span>
                        
<span class="c1">#                     elif self.phases_h[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                         w_vap_wet = (Th_mean - Th_sat_mean)/(Th_mean - T_wall)</span>
<span class="c1">#                         # The line below re-calculates alpha_h in case of having a vapor-wet condition</span>
<span class="c1">#                         alpha_h = alpha_h_2phase - w_vap_wet*(alpha_h_2phase - alpha_h) # the last alpha_h in this equation is the 1 Phase calculation</span>

<span class="c1">#             &quot;3.2) Cold side - User defined&quot;</span>
            
<span class="c1">#             # User Defined</span>
<span class="c1">#             if self.C.HeatExchange_Correlation == &quot;User-Defined&quot;:</span>
<span class="c1">#                 if self.phases_c[k] == &quot;liquid&quot;:</span>
<span class="c1">#                     alpha_c = self.C.h_liq</span>
<span class="c1">#                 elif self.phases_c[k] == &quot;vapor&quot;:</span>
<span class="c1">#                     alpha_c = self.C.h_vap</span>
<span class="c1">#                 elif self.phases_c[k] == &quot;two-phase&quot;:</span>
<span class="c1">#                     alpha_c = self.C.h_twophase</span>
<span class="c1">#                 elif self.phases_c[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                     alpha_c = self.C.h_vapwet</span>
<span class="c1">#                 elif self.phases_c[k] == &quot;two-phase-dryout&quot;:</span>
<span class="c1">#                     alpha_c = self.C.h_tpdryout</span>
<span class="c1">#                 elif self.phases_c[k] == &quot;transcritical&quot;:</span>
<span class="c1">#                     alpha_c = self.C.h_transcrit</span>
                    
<span class="c1">#             elif self.C.HeatExchange_Correlation == &quot;Correlation&quot;:</span>

<span class="c1">#                 # Heat transfer coefficient calculated from Correlations:</span>
<span class="c1">#                 # Evaluate phases</span>
                
<span class="c1">#                 # 1 phase case</span>
<span class="c1">#                 if self.phases_c[k] == &quot;liquid&quot; or self.phases_c[k] == &quot;vapor&quot; or self.phases_c[k] == &quot;transcritical&quot;:</span>
<span class="c1">#                     mu_c, Pr_c, k_c, mu_wall, mu_rat, _, _ = propsfluid(Tc_mean, p_c_mean, T_wall_c, self.C_su.fluid, False)</span>
            
<span class="c1">#                     if self.HTX_Type == &#39;Plate&#39; and self.C_su.fluid == &#39;water&#39;:</span>
<span class="c1">#                         alpha_c = water_plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.H_Dh)</span>

<span class="c1">#                     elif self.C.Correlation_1phase  == &quot;Gnielinski&quot;:</span>
<span class="c1">#                         try:</span>
<span class="c1">#                             mu_c, Pr_c, k_c, mu_wall, mu_rat, _, _ = propsfluid(Tc_mean, p_c_mean, T_wall_c, self.C_su.fluid, False)</span>
<span class="c1">#                             Pr_c_w, mu_c_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, Tc_mean,&#39;P&#39;,p_c_mean,self.C_su.fluid)</span>
<span class="c1">#                         except (ValueError):</span>
<span class="c1">#                             if self.phases_c[k] == &quot;liquid&quot;:</span>
<span class="c1">#                                 mu_c, Pr_c, k_c, mu_wall, mu_rat, _, _ = propsfluid(Tc_mean-0.1, p_c_mean, T_wall_c, self.C_su.fluid, False)</span>
<span class="c1">#                                 Pr_c_w, mu_c_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, Tc_mean-1,&#39;P&#39;,p_c_mean,self.C_su.fluid)</span>
<span class="c1">#                             elif self.phases_c[k] == &quot;vapor&quot;:</span>
<span class="c1">#                                 mu_c, Pr_c, k_c, mu_wall, mu_rat, _, _ = propsfluid(Tc_mean+0.1, p_c_mean, T_wall_c, self.C_su.fluid, False)</span>
<span class="c1">#                                 Pr_c_w, mu_c_w = CP.PropsSI((&#39;PRANDTL&#39;,&#39;V&#39;), &#39;T&#39;, Tc_mean+1,&#39;P&#39;,p_c_mean,self.C_su.fluid)</span>
                        
<span class="c1">#                         if self.HTX_Type == &#39;Plate&#39;:</span>
<span class="c1">#                             alpha_c = gnielinski_pipe_htc(mu_c, Pr_c, Pr_c_w, k_c, G_c, self.params[&#39;H_Dh&#39;], self.params[&#39;l&#39;]) # Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                        
<span class="c1">#                         elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
<span class="c1">#                             alpha_c = gnielinski_pipe_htc(mu_c, Pr_c, Pr_c_w, k_c, G_c, self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;], self.params[&#39;Tube_L&#39;]) # Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                        
<span class="c1">#                         elif self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
<span class="c1">#                             alpha_c = gnielinski_pipe_htc(mu_c, Pr_c, Pr_c_w, k_c, G_c, self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;], self.params[&#39;Tube_L&#39;]*self.params[&#39;n_passes&#39;]) # Muley_Manglik_BPHEX_HTC(mu_c, mu_c_w, Pr_c, k_c, G_c, self.geom.C_Dh, self.geom.chevron_angle) # Simple_Plate_HTC(mu_c, Pr_c, k_c, G_c, self.geom.C_Dh) # </span>
                            
<span class="c1">#                     elif self.C.Correlation_1phase == &#39;Shell_Bell_Delaware_HTC&#39;:</span>
<span class="c1">#                         alpha_c = shell_bell_delaware_htc(self.mdot_c, Tc_mean, T_wall, p_c_mean, self.C_su.fluid, self.params)</span>
                         
<span class="c1">#                     elif self.C.Correlation_1phase == &#39;Tube_And_Fins&#39;:</span>
<span class="c1">#                         alpha_c = htc_tube_and_fins(self.C_su.fluid, self.params, p_c_mean, Tc_mean, self.mdot_c, self.params[&#39;Fin_type&#39;])[0]</span>
                    
<span class="c1">#                     # if self.C.Correlation_1phase  == &quot;Gnielinski&quot;:</span>
<span class="c1">#                     #     alpha_c, _ = Gnielinski_Pipe_HTC(mu_c, Pr_c, k_c, G_c, self.geom.H_Dh, self.geom.l)</span>

<span class="c1">#                 # 2 phases case</span>
<span class="c1">#                 elif self.phases_c[k] == &quot;two-phase&quot; or self.phases_c[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                     if self.phases_c[k] == &quot;two-phase&quot;:</span>
<span class="c1">#                         x_c = min(1, max(0, 0.5*(self.x_vec_c[k] + self.x_vec_c[k])))</span>
<span class="c1">#                     elif self.phases_c[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                         x_c = 1</span>
                        
<span class="c1">#                     # Thermodynamical variables</span>
<span class="c1">#                     mu_c_l = CP.PropsSI(&quot;V&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                     k_c_l = CP.PropsSI(&quot;L&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                     Pr_c_l = CP.PropsSI(&quot;Prandtl&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                     rho_c_l = CP.PropsSI(&quot;D&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                     rho_c_v = CP.PropsSI(&quot;D&quot;, &quot;Q&quot;, 1, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                     i_fg_c = CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 1, &#39;P&#39;, p_c_mean, self.C_su.fluid) - CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 0, &#39;P&#39;, p_c_mean, self.C_su.fluid)</span>
                    
<span class="c1">#                     # This boolean serves to spare to recalculate this properties in the dry-out analysis further ahead.</span>
<span class="c1">#                     self.ColdSide_Props_Calculated = True</span>
                    
<span class="c1">#                     # !!! Include different types of Correlation HERE</span>
<span class="c1">#                     if self.C.Correlation_2phase == &quot;Han_cond_BPHEX&quot;:</span>
<span class="c1">#                         alpha_c_2phase, _ = han_cond_BPHEX_HTC(x_c, mu_c_l, k_c_l, Pr_c_l, rho_c_l, rho_c_v, G_c, self.params[&#39;C_Dh&#39;], self.params[&#39;plate_pitch_co&#39;], self.params[&#39;chevron_angle&#39;])</span>
                    
<span class="c1">#                     elif self.C.Correlation_2phase == &quot;Han_Boiling_BPHEX_HTC&quot;:</span>
<span class="c1">#                         alpha_c_2phase, _ = han_boiling_BPHEX_HTC(min(x_c, self.x_di_c), mu_c_l, k_c_l, Pr_c_l, rho_c_l, rho_c_v,  i_fg_c, G_c, LMTD*self.F, self.Qvec_c[k], alpha_h, self.params[&#39;C_Dh&#39;], self.params[&#39;chevron_angle&#39;], self.params[&#39;plate_pitch_co&#39;])</span>
                    
<span class="c1">#                     elif self.C.Correlation_2phase == &quot;Boiling_curve&quot;:                  </span>
<span class="c1">#                         alpha_c_2phase = self.C_f_boiling(abs(T_wall - Tc_mean))</span>
                    
<span class="c1">#                     else:</span>
<span class="c1">#                         raise ValueError(&quot;Correlation not found for Cold Side 2-Phase&quot;)</span>
                            
<span class="c1">#                     if self.phases_c[k] == &quot;two-phase&quot;:</span>
<span class="c1">#                         alpha_c = alpha_c_2phase</span>
<span class="c1">#                     elif self.phases_c[k] == &quot;vapor-wet&quot;:</span>
<span class="c1">#                         w_vap_wet = (Tc_mean - Tc_sat_mean)/(Tc_mean - T_wall)</span>
<span class="c1">#                         #The line below re-calculates alpha_h in case of having a vapor-wet condition</span>
<span class="c1">#                         alpha_c = alpha_c_2phase - w_vap_wet*(alpha_c_2phase - alpha_c) #the last alpha_c in this equation is the 1 Phase calculation</span>
            
<span class="c1">#             &quot;3.3) Store the heat transfer coefficients&quot;</span>
            
<span class="c1">#             self.alpha_c.append(alpha_c)</span>
<span class="c1">#             self.alpha_h.append(alpha_h)</span>
            
<span class="c1">#             &quot;4) Recover some parameters and conductivity calculation and compute UA_avail&quot;</span>
            
<span class="c1">#             if self.HTX_Type == &#39;Plate&#39;:     </span>
<span class="c1">#                 # In the equation below, thickness resistance is given with respect to A_h arbitrarely</span>
<span class="c1">#                 UA_avail = 1/((1+self.params[&#39;fooling&#39;])/(alpha_h*self.params[&#39;A_h&#39;]) + 1/(alpha_c*self.params[&#39;A_c&#39;]) + self.params[&#39;t_plates&#39;]/(self.params[&#39;plate_cond&#39;])) </span>
                
<span class="c1">#             elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:       </span>
                
<span class="c1">#                 fact_cond_1 = np.log(self.params[&#39;Tube_OD&#39;]/(self.params[&#39;Tube_OD&#39;] - 2*self.params[&#39;Tube_t&#39;]))</span>
<span class="c1">#                 fact_cond_2 = 2*np.pi*self.params[&#39;tube_cond&#39;]*self.params[&#39;Tube_L&#39;]*self.params[&#39;n_series&#39;]*self.params[&#39;n_tubes&#39;]</span>
<span class="c1">#                 R_cond = fact_cond_1/fact_cond_2                      </span>

<span class="c1">#                 self.A_in_tubes = self.params[&#39;Tube_pass&#39;]*self.params[&#39;Tube_L&#39;]*self.params[&#39;n_tubes&#39;]*np.pi*((self.params[&#39;Tube_OD&#39;] - 2*self.params[&#39;Tube_t&#39;]))</span>
<span class="c1">#                 self.A_out_tubes = self.params[&#39;Tube_pass&#39;]*self.params[&#39;Tube_L&#39;]*self.params[&#39;n_tubes&#39;]*np.pi*(self.params[&#39;Tube_OD&#39;])</span>
            
<span class="c1">#                 if self.params[&#39;foul_s&#39;] != None:</span>
<span class="c1">#                     R_fouling_s = self.params[&#39;foul_s&#39;] / self.A_out_tubes</span>
<span class="c1">#                 else: </span>
<span class="c1">#                     R_fouling_s = 0</span>
    
<span class="c1">#                 if self.params[&#39;foul_t&#39;] != None:</span>
<span class="c1">#                     R_fouling_t = self.params[&#39;foul_t&#39;] / self.A_in_tubes</span>
<span class="c1">#                 else: </span>
<span class="c1">#                     R_fouling_t = 0                </span>
            
<span class="c1">#                 UA_avail = 1/(1/(alpha_c*self.A_in_tubes) + 1/(alpha_h*self.A_out_tubes) + R_fouling_s + R_fouling_t + R_cond) </span>
            
<span class="c1">#             elif self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
                
<span class="c1">#                 fact_cond_1 = np.log(self.params[&#39;Tube_OD&#39;]/(self.params[&#39;Tube_OD&#39;] - 2*self.params[&#39;Tube_t&#39;]))</span>
<span class="c1">#                 fact_cond_2 = 2*np.pi*self.params[&#39;Tube_cond&#39;]*self.params[&#39;Tube_L&#39;]*self.params[&#39;n_tubes&#39;]*self.params[&#39;n_passes&#39;]</span>
<span class="c1">#                 R_cond = fact_cond_1/fact_cond_2                      </span>
                
<span class="c1">#                 self.A_in_tubes = self.params[&#39;n_passes&#39;]*self.params[&#39;Tube_L&#39;]*self.params[&#39;n_tubes&#39;]*np.pi*((self.params[&#39;Tube_OD&#39;] - 2*self.params[&#39;Tube_t&#39;])) # *self.geom.n_passes </span>
<span class="c1">#                 self.A_out_tubes = self.params[&#39;A_finned&#39;]</span>
                            
<span class="c1">#                 #☺ self.A_out_tubes = 8705 #self.geom.n_passes*self.geom.Tube_L*self.geom.n_tubes*np.pi*(self.geom.Tube_OD)</span>
            
<span class="c1">#                 R_fouling = 0 # self.geom.fouling / self.A_out_tubes             </span>
                        
<span class="c1">#                 # In the equation below, thickness resistance is given with respect to A_h arbitrarely</span>
            
<span class="c1">#                 if self.params[&#39;Fin_Side&#39;] == &#39;H&#39;: # Fin side is the hot side </span>
<span class="c1">#                     UA_avail =  1/(1/(alpha_c*self.A_in_tubes) + 1/(alpha_h*self.A_out_tubes) + R_fouling + R_cond) # 1/((1+self.geom.fooling)/(alpha_h*self.geom.A_h) + 1/(alpha_c*self.geom.A_c) + t/(self.geom.tube_cond)) </span>
<span class="c1">#                 else: </span>
<span class="c1">#                     UA_avail =  1/(1/(alpha_h*self.A_in_tubes) + 1/(alpha_c*self.A_out_tubes) + R_fouling + R_cond) # 1/((1+self.geom.fooling)/(alpha_h*self.geom.A_h) + 1/(alpha_c*self.geom.A_c) + t/(self.geom.tube_cond)) </span>
      
<span class="c1">#             # R_fooling_h = self.params.H.R_fooling </span>
<span class="c1">#             # R_fooling_c = self.params.C.R_fooling</span>
            
<span class="c1">#             &quot;5) Calculate w, the main objective of this function. This variable serves for residual minimization in the solver&quot;</span>
            
<span class="c1">#             w.append(UA_req/UA_avail)</span>
            
<span class="c1">#             self.w = w</span>
            
<span class="c1">#             if self.HTX_Type == &#39;Plate&#39;:</span>
<span class="c1">#                 self.Avec_h.append(w[k]*self.params[&#39;A_h&#39;]) </span>
                
<span class="c1">#             if self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
<span class="c1">#                 self.Avec_h.append(w[k]*self.params[&#39;A_eff&#39;])</span>

<span class="c1">#             if self.HTX_Type == &#39;Tube&amp;Fins&#39;:</span>
<span class="c1">#                 self.Avec_h.append(w[k]*self.params[&#39;A_finned&#39;])</span>
            
<span class="c1">#             &quot;5.1) Calculate dryout incipience only if subcritical&quot;</span>
<span class="c1">#             if not self.dry_out_c and self.phases_h[k] == &quot;two-phase&quot; and not self.Transcritical_c:</span>
<span class="c1">#                     if not self.ColdSide_Props_Calculated:</span>
<span class="c1">#                         #If these properties where not calculated before, do it:</span>
<span class="c1">#                         mu_c_l = CP.PropsSI(&quot;V&quot;, &quot;Q&quot;, 0, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                         rho_c_l = CP.PropsSI(&#39;D&#39;, &#39;Q&#39;, 0, &#39;P&#39;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                         rho_c_v = CP.PropsSI(&#39;D&#39;, &#39;Q&#39;, 1, &#39;P&#39;, p_c_mean, self.H_su.fluid)</span>
<span class="c1">#                         i_fg_c = CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 1, &#39;P&#39;, p_c_mean, self.C_su.fluid) - CP.PropsSI(&#39;H&#39;, &#39;Q&#39;, 0, &#39;P&#39;, p_c_mean, self.C_su.fluid)</span>
                    
<span class="c1">#                     P_star_c = p_c_mean/CP.PropsSI(&quot;Pcrit&quot;, &quot;Q&quot;, 1, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
<span class="c1">#                     q_c = self.Qvec_c[k]/self.Avec_h[k]</span>
<span class="c1">#                     try:</span>
<span class="c1">#                         sigma_c_l = CP.PropsSI(&quot;I&quot;, &#39;Q&#39;, 0, &quot;P&quot;, p_c_mean, self.C_su.fluid)</span>
                        
<span class="c1">#                         if self.HTX_Type == &#39;Plate&#39;:</span>
<span class="c1">#                             self.x_di_c = kim_dry_out_incipience(G_c, q_c, self.params[&#39;C_Dh&#39;], P_star_c, rho_c_l, rho_c_v, mu_c_l, sigma_c_l, i_fg_c)</span>
                            
<span class="c1">#                         elif self.HTX_Type == &#39;Shell&amp;Tube&#39;:</span>
<span class="c1">#                             self.x_di_c = kim_dry_out_incipience(G_c, q_c,self.params[&#39;Tube_OD&#39;]-2*self.params[&#39;Tube_t&#39;], P_star_c, rho_c_l, rho_c_v, mu_c_l, sigma_c_l, i_fg_c)</span>
<span class="c1">#                     except:</span>
<span class="c1">#                         self.x_di_c = -1</span>
<span class="c1">#         if debug:</span>
<span class="c1">#             print(Q, 1-sum(w))</span>
            
<span class="c1">#         return 1-sum(w)</span>

<span class="c1"># #%%</span>
<span class="c1">#     def solve_HX(self):</span>
<span class="c1">#         &quot;&quot;&quot; </span>
<span class="c1">#         Solve the objective function using Brent&#39;s method and the maximum heat transfer </span>
<span class="c1">#         rate calculated from the pinching analysis</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         self.Q = scipy.optimize.brentq(self.objective_function, 1e-5, self.Qmax-1e-10, rtol = 1e-14, xtol = 1e-10)</span>
<span class="c1">#         return self.Q</span>
    
<span class="c1"># #%%</span>
<span class="c1">#     def plot_objective_function(self, N = 100):</span>
<span class="c1">#         &quot;&quot;&quot; Plot the objective function &quot;&quot;&quot;</span>
<span class="c1">#         Q = np.linspace(1e-5,self.Qmax,N)</span>
<span class="c1">#         r = np.array([self.objective_function(_Q) for _Q in Q])</span>
<span class="c1">#         fig, ax = plt.subplots()</span>
<span class="c1">#         ax.plot(Q, r)</span>
<span class="c1">#         ax.grid(True)</span>
<span class="c1">#         # plt.show()²</span>
        
<span class="c1"># #%%</span>
<span class="c1">#     def plot_ph_pair(self):</span>
<span class="c1">#         import warnings</span>
<span class="c1">#         warnings.simplefilter(&quot;ignore&quot;)</span>
<span class="c1">#         &quot;&quot;&quot; Plot p-h plots for the pair of working fluids &quot;&quot;&quot;</span>
<span class="c1">#         Ph_diagram_h = PropertyPlot(self.H_su.fluid, &quot;PH&quot;, unit_system = &quot;EUR&quot;)</span>
<span class="c1">#         plt.plot(0.001*np.array(self.hvec_h), self.pvec_h*1e-05,&#39;s-&#39;)</span>
<span class="c1">#         Ph_diagram_h.calc_isolines()</span>
<span class="c1">#         Ph_diagram_h.title(&quot;Hot side P-h diagram. Fluid: &quot; + str(self.H_su.fluid))</span>
<span class="c1">#         Ph_diagram_h.show()</span>
<span class="c1">#         #----------------------------------------------------------------------</span>
<span class="c1">#         Ph_diagram_c = PropertyPlot(self.C_su.fluid, &quot;PH&quot;, unit_system = &quot;EUR&quot;)</span>
<span class="c1">#         plt.plot(0.001*np.array(self.hvec_c), self.pvec_c*1e-05,&#39;s-&#39;)</span>
<span class="c1">#         Ph_diagram_c.calc_isolines()</span>
<span class="c1">#         Ph_diagram_c.title(&quot;Cold side P-h diagram. Fluid: &quot; + str(self.C_su.fluid))</span>
<span class="c1">#         Ph_diagram_c.show()</span>
<span class="c1">#         warnings.simplefilter(&quot;default&quot;)</span>

<span class="c1"># #%%</span>
<span class="c1">#     def plot_Ts_pair(self):</span>
<span class="c1">#         import warnings</span>
<span class="c1">#         warnings.simplefilter(&quot;ignore&quot;)</span>
<span class="c1">#         &quot;&quot;&quot; Plot a T-s plot for the pair of working fluids &quot;&quot;&quot;</span>
<span class="c1">#         Ph_diagram_h = PropertyPlot(self.H_su.fluid, &quot;TS&quot;, unit_system = &quot;EUR&quot;)</span>
<span class="c1">#         plt.plot(0.001*self.svec_h,self.Tvec_h - 273.15,&#39;s-&#39;)</span>
<span class="c1">#         Ph_diagram_h.calc_isolines()</span>
<span class="c1">#         Ph_diagram_h.title(&quot;Hot side T-s diagram. Fluid: &quot; + str(self.H_su.fluid))</span>
<span class="c1">#         Ph_diagram_h.show()</span>
<span class="c1">#         # #----------------------------------------------------------------------</span>
<span class="c1">#         Ph_diagram_c = PropertyPlot(self.C_su.fluid, &quot;TS&quot;, unit_system = &quot;EUR&quot;)</span>
<span class="c1">#         plt.plot(0.001*self.svec_c,self.Tvec_c - 273.15,&#39;s-&#39;)</span>
<span class="c1">#         Ph_diagram_c.calc_isolines()</span>
<span class="c1">#         Ph_diagram_c.title(&quot;Cold side T-s diagram. Fluid: &quot; + str(self.C_su.fluid))</span>
<span class="c1">#         Ph_diagram_c.show()</span>
<span class="c1">#         warnings.simplefilter(&quot;default&quot;)</span>

<span class="c1"># #%%</span>
<span class="c1">#     def plot_cells(self, fName = &#39;&#39;, dpi = 400):</span>
<span class="c1">#         &quot;&quot;&quot; Plot the cells of the heat exchanger &quot;&quot;&quot;</span>
<span class="c1">#         plt.figure(figsize = (4,3))</span>
<span class="c1">#         plt.plot(self.hnorm_h, self.Tvec_h, &#39;rs-&#39;)</span>
<span class="c1">#         plt.plot(self.hnorm_c, self.Tvec_c, &#39;bs-&#39;)</span>
<span class="c1">#         plt.xlim(0,1)</span>
<span class="c1">#         plt.ylabel(&#39;T [K]&#39;) </span>
<span class="c1">#         plt.xlabel(r&#39;$\hat h$ [-]&#39;)</span>
<span class="c1">#         plt.grid(True)</span>
<span class="c1">#         plt.tight_layout(pad = 0.2) </span>
<span class="c1">#         plt.show()</span>
<span class="c1">#         if fName != &#39;&#39;:</span>
<span class="c1">#             plt.savefig(fName, dpi = dpi)</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Basile Chaudoir, Elise Neven
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../../../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>